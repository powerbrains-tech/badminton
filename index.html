<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Badminton Check-in üìù</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Kanit', sans-serif; background-color: #f1f5f9; }
        .court-card { transition: all 0.3s; }
        .court-1 { background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); }
        .court-2 { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); }
        .court-3 { background: linear-gradient(135deg, #ec4899 0%, #db2777 100%); }
        .court-default { background: linear-gradient(135deg, #64748b 0%, #475569 100%); }
        
        /* Toggle Switch UI */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #68D391;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #68D391;
        }

        .admin-only { display: none !important; } 
        .show-admin .admin-only { display: block !important; }
        .show-admin .admin-flex { display: flex !important; }
        
        .player-inactive { opacity: 0.5; filter: grayscale(100%); }
    </style>
</head>
<body class="p-4 max-w-2xl mx-auto pb-40">

    <div class="flex justify-between items-center mb-6 sticky top-0 bg-[#f1f5f9] z-10 py-2">
        <div>
            <h1 class="text-2xl font-bold text-slate-800">üè∏ Badminton <span class="text-indigo-600 text-sm align-top">Pro</span></h1>
            <div id="statusIndicator" class="text-[10px] inline-block px-2 py-0.5 rounded bg-gray-200 text-gray-500">Connecting...</div>
        </div>
        <button onclick="toggleAdmin()" class="text-xl p-2 bg-white shadow rounded-full hover:scale-110 transition">üîí</button>
    </div>

    <div class="bg-slate-800 text-white p-4 rounded-xl shadow-lg mb-6 admin-only hidden" id="adminPanel">
        <h3 class="font-bold text-sm mb-3 text-slate-300 flex justify-between items-center">
            ‚öôÔ∏è ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡πä‡∏ß‡∏ô
            <button onclick="resetDay()" class="text-[10px] bg-red-500/20 text-red-300 px-2 py-1 rounded hover:bg-red-500 hover:text-white transition">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ß‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà (‡πÄ‡∏≠‡∏≤‡∏ï‡∏¥‡πä‡∏Å‡∏≠‡∏≠‡∏Å‡∏´‡∏°‡∏î)</button>
        </h3>
        
        <div class="flex items-center gap-3 mb-4">
            <span class="text-sm">‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏µ‡πà‡∏Ñ‡∏≠‡∏£‡πå‡∏ó:</span>
            <select id="courtCount" class="bg-slate-700 border border-slate-600 rounded px-2 py-1 text-sm outline-none">
                <option value="1">1 ‡∏Ñ‡∏≠‡∏£‡πå‡∏ó</option>
                <option value="2" selected>2 ‡∏Ñ‡∏≠‡∏£‡πå‡∏ó</option>
                <option value="3">3 ‡∏Ñ‡∏≠‡∏£‡πå‡∏ó</option>
            </select>
        </div>

        <button id="btnGenerate" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white py-3 rounded-lg font-bold shadow-lg active:scale-95 transition flex justify-center items-center gap-2">
            üöÄ ‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠)
        </button>
        <div class="flex justify-between text-[10px] text-slate-400 mt-2">
            <span>*‡∏à‡∏∞‡∏™‡∏∏‡πà‡∏°‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢ ‚úÖ</span>
            <span id="activeCountDisplay">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏•‡πà‡∏ô: 0 ‡∏Ñ‡∏ô</span>
        </div>
    </div>

    <div id="courtsContainer" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
        </div>

    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4">
        <div class="flex gap-2 mb-4 admin-only hidden" id="addPlayerBox">
            <input type="text" id="inputName" placeholder="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà..." class="flex-1 bg-slate-50 border rounded px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-500">
            <button id="btnAdd" class="bg-indigo-600 text-white px-4 rounded font-bold hover:bg-indigo-700">+</button>
        </div>

        <div class="flex justify-between items-end mb-3 px-1 pb-2 border-b border-slate-100">
            <div>
                <span class="text-sm font-bold text-slate-700">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</span>
                <span class="text-xs text-slate-400 ml-1">(‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î <span id="totalCount">0</span>)</span>
            </div>
            <div class="text-[10px] text-slate-400">‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ‚úÖ</div>
        </div>

        <div id="listContainer" class="space-y-2">
            </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, setDoc, writeBatch } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        // ------------------------------------------------------------------
        const firebaseConfig = {
            apiKey: "AIzaSyC6VSnH2H5zyFPbya0axgP38WiGczYU-oU",
            authDomain: "badminton-smasher-ai.firebaseapp.com",
            projectId: "badminton-smasher-ai",
            storageBucket: "badminton-smasher-ai.firebasestorage.app",
            messagingSenderId: "518167738562",
            appId: "1:518167738562:web:8ba84a7c1a350d16e3e35b",
            measurementId: "G-6X20YG49K9"
        };
        // ------------------------------------------------------------------

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // --- Admin Logic ---
        window.toggleAdmin = function() {
            const body = document.body;
            if (body.classList.contains('show-admin')) {
                body.classList.remove('show-admin');
                document.getElementById('adminPanel').classList.remove('block');
                document.getElementById('addPlayerBox').classList.remove('flex');
            } else {
                const pass = prompt("‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏ô‡∏à‡∏±‡∏î (Admin):");
                if (pass === "1234") { 
                    body.classList.add('show-admin');
                    document.getElementById('adminPanel').classList.remove('hidden');
                    document.getElementById('adminPanel').classList.add('block');
                    document.getElementById('addPlayerBox').classList.remove('hidden');
                    document.getElementById('addPlayerBox').classList.add('flex');
                }
            }
        }

        const playersRef = collection(db, "players");
        const systemRef = doc(db, "system", "courts_state");

        let playersList = [];
        let activeMatches = [];

        // Listen Players
        onSnapshot(playersRef, (snapshot) => {
            document.getElementById('statusIndicator').innerText = "Online üü¢";
            document.getElementById('statusIndicator').className = "text-[10px] inline-block px-2 py-0.5 rounded bg-green-100 text-green-700";
            
            playersList = [];
            snapshot.forEach(doc => playersList.push({ id: doc.id, ...doc.data() }));
            
            // Sort: ‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô -> ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏° Score
            playersList.sort((a, b) => {
                if (a.isPresent === b.isPresent) return b.score - a.score;
                return a.isPresent ? -1 : 1;
            });
            
            renderList();
        });

        // Listen Matches
        onSnapshot(systemRef, (docSnap) => {
            if (docSnap.exists()) {
                activeMatches = docSnap.data().matches || [];
                renderCourts();
            } else {
                activeMatches = [];
                renderCourts();
            }
        });

        // Add Player
        document.getElementById('btnAdd').onclick = async () => {
            const name = document.getElementById('inputName').value.trim();
            if (!name) return;
            if(playersList.some(p => p.name == name)) { alert('‡∏ä‡∏∑‡πà‡∏≠‡∏ã‡πâ‡∏≥!'); return; }
            await addDoc(playersRef, { 
                name: name, score: 1000, matches: 0, wins: 0, 
                isPresent: true, // ‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ï‡∏¥‡πä‡∏Å‡∏ñ‡∏π‡∏Å‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô
                createdAt: Date.now() 
            });
            document.getElementById('inputName').value = '';
        };

        // Toggle Presence (Check-in)
        window.togglePresence = async (id, currentStatus) => {
            await updateDoc(doc(db, "players", id), { isPresent: !currentStatus });
        }

        // Reset Day (Uncheck all)
        window.resetDay = async () => {
            if(!confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà?")) return;
            const batch = writeBatch(db);
            playersList.forEach(p => {
                const ref = doc(db, "players", p.id);
                batch.update(ref, { isPresent: false });
            });
            await batch.commit();
        }

        window.deletePlayer = async (id) => {
            if(confirm("‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏µ‡πâ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏ñ‡∏≤‡∏ß‡∏£?")) await deleteDoc(doc(db, "players", id));
        }

        // --- Match Generation Logic ---
        document.getElementById('btnGenerate').onclick = async () => {
            const maxCourts = parseInt(document.getElementById('courtCount').value);
            const currentMatchesCount = activeMatches.length;
            const slotsAvailable = maxCourts - currentMatchesCount;

            if (slotsAvailable <= 0) return alert("‡∏Ñ‡∏≠‡∏£‡πå‡∏ó‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö");

            // 1. ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà "‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠" ‡πÅ‡∏•‡∏∞ "‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô"
            const playingIds = new Set();
            activeMatches.forEach(m => {
                m.teamA.forEach(p => playingIds.add(p.id));
                m.teamB.forEach(p => playingIds.add(p.id));
            });

            // Filter: ‡∏ï‡πâ‡∏≠‡∏á isPresent = true ‡πÅ‡∏•‡∏∞ ‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô playingIds
            let availablePlayers = playersList.filter(p => p.isPresent && !playingIds.has(p.id));

            if (availablePlayers.length < 4) return alert(`‡∏Ñ‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏Ñ‡∏≠‡∏£‡πå‡∏ó‡πÉ‡∏´‡∏°‡πà (‡∏ß‡πà‡∏≤‡∏á ${availablePlayers.length} ‡∏Ñ‡∏ô)`);

            // Sort ‡∏Ñ‡∏ô‡∏ß‡πà‡∏≤‡∏á‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏°‡∏ï‡∏ä‡πå‡∏ô‡πâ‡∏≠‡∏¢‡∏™‡∏∏‡∏î (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏±‡πà‡∏ß‡∏ñ‡∏∂‡∏á)
            availablePlayers.sort((a, b) => a.matches - b.matches || 0.5 - Math.random());

            const newMatches = [...activeMatches];
            
            for (let i = 0; i < slotsAvailable; i++) {
                if (availablePlayers.length < 4) break;
                let selected = availablePlayers.slice(0, 4);
                availablePlayers = availablePlayers.slice(4);

                // Sort Score ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏ó‡∏µ‡∏° Balance
                selected.sort((a, b) => b.score - a.score);
                
                const matchObj = {
                    id: Date.now() + i,
                    courtNo: findNextCourtNo(newMatches),
                    teamA: [selected[0], selected[3]], // ‡πÄ‡∏Å‡πà‡∏á‡∏™‡∏∏‡∏î ‡∏Ñ‡∏π‡πà ‡∏≠‡πà‡∏≠‡∏ô‡∏™‡∏∏‡∏î
                    teamB: [selected[1], selected[2]], // ‡∏Å‡∏•‡∏≤‡∏á ‡∏Ñ‡∏π‡πà ‡∏Å‡∏•‡∏≤‡∏á
                    startTime: Date.now()
                };
                newMatches.push(matchObj);
            }

            await setDoc(systemRef, { matches: newMatches });
        };

        function findNextCourtNo(currentList) {
            const usedNos = new Set(currentList.map(m => m.courtNo));
            let i = 1;
            while (usedNos.has(i)) i++;
            return i;
        }

        window.finishMatch = async (matchId, winnerTeam) => {
            if (!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ó‡∏µ‡∏° ${winnerTeam} ‡∏ä‡∏ô‡∏∞?`)) return;
            const match = activeMatches.find(m => m.id === matchId);
            if (!match) return;

            const winners = winnerTeam === 'A' ? match.teamA : match.teamB;
            const losers = winnerTeam === 'A' ? match.teamB : match.teamA;
            const updatePromises = [];

            winners.forEach(p => {
                const curr = playersList.find(x => x.id === p.id);
                if(curr) updatePromises.push(updateDoc(doc(db, "players", p.id), { score: curr.score + 20, matches: curr.matches + 1, wins: curr.wins + 1 }));
            });
            losers.forEach(p => {
                const curr = playersList.find(x => x.id === p.id);
                if(curr) updatePromises.push(updateDoc(doc(db, "players", p.id), { score: Math.max(0, curr.score + 5), matches: curr.matches + 1 }));
            });

            await Promise.all(updatePromises);
            const remainingMatches = activeMatches.filter(m => m.id !== matchId);
            await setDoc(systemRef, { matches: remainingMatches });
        };

        window.cancelMatch = async (matchId) => {
            if(!confirm("‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Ñ‡∏≠‡∏£‡πå‡∏ó‡∏ô‡∏µ‡πâ?")) return;
            const remainingMatches = activeMatches.filter(m => m.id !== matchId);
            await setDoc(systemRef, { matches: remainingMatches });
        }

        // --- Render ---
        function renderCourts() {
            const container = document.getElementById('courtsContainer');
            container.innerHTML = '';
            activeMatches.sort((a, b) => a.courtNo - b.courtNo);

            if (activeMatches.length === 0) {
                container.innerHTML = `<div class="text-center text-slate-400 py-6 col-span-full border-2 border-dashed border-slate-200 rounded-xl">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô<br>‡∏Å‡∏î üîí ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</div>`;
                return;
            }

            activeMatches.forEach(m => {
                let colorClass = m.courtNo === 1 ? 'court-1' : (m.courtNo === 2 ? 'court-2' : 'court-3');
                container.innerHTML += `
                    <div class="rounded-xl p-1 shadow-lg text-white relative ${colorClass} court-card">
                        <div class="flex justify-between items-center px-2 py-1">
                            <span class="font-bold text-xs bg-black/20 px-2 rounded">Court ${m.courtNo}</span>
                            <button onclick="cancelMatch(${m.id})" class="text-white/60 hover:text-white text-xs admin-only">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                        </div>
                        <div class="bg-white rounded-lg p-3 text-slate-800 mt-1">
                            <div class="flex justify-between items-center mb-2 p-1.5 rounded hover:bg-slate-50">
                                <div><div class="font-bold">${m.teamA[0].name}</div><div class="font-bold">${m.teamA[1].name}</div></div>
                                <button onclick="finishMatch(${m.id}, 'A')" class="admin-only bg-green-100 text-green-700 px-3 py-1 rounded-full text-xs font-bold hover:bg-green-200">A Win</button>
                            </div>
                            <div class="text-center text-[10px] text-slate-300 font-bold">- VS -</div>
                            <div class="flex justify-between items-center mt-2 p-1.5 rounded hover:bg-slate-50">
                                <div><div class="font-bold">${m.teamB[0].name}</div><div class="font-bold">${m.teamB[1].name}</div></div>
                                <button onclick="finishMatch(${m.id}, 'B')" class="admin-only bg-green-100 text-green-700 px-3 py-1 rounded-full text-xs font-bold hover:bg-green-200">B Win</button>
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        function renderList() {
            const list = document.getElementById('listContainer');
            const totalCount = document.getElementById('totalCount');
            const activeCountDisplay = document.getElementById('activeCountDisplay');
            
            list.innerHTML = '';
            totalCount.innerText = playersList.length;
            
            // Count active players
            const activePlayers = playersList.filter(p => p.isPresent).length;
            activeCountDisplay.innerText = `‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏•‡πà‡∏ô: ${activePlayers} ‡∏Ñ‡∏ô`;

            // Check who is currently playing
            const playingIds = new Set();
            activeMatches.forEach(m => {
                m.teamA.forEach(p => playingIds.add(p.id));
                m.teamB.forEach(p => playingIds.add(p.id));
            });

            playersList.forEach((p, idx) => {
                const isPlaying = playingIds.has(p.id);
                const winRate = p.matches ? Math.round((p.wins/p.matches)*100) : 0;
                const isPresent = p.isPresent;
                
                // Style for inactive players
                const inactiveClass = !isPresent ? 'bg-slate-50 opacity-60' : 'bg-white';
                const playingClass = isPlaying ? 'ring-2 ring-indigo-400 bg-indigo-50' : '';

                list.innerHTML += `
                    <div class="flex justify-between items-center p-3 rounded-lg border border-slate-100 mb-2 transition-all ${inactiveClass} ${playingClass}">
                        <div class="flex items-center gap-3">
                            <div class="admin-only">
                                <input type="checkbox" ${isPresent ? 'checked' : ''} 
                                    onchange="togglePresence('${p.id}', ${isPresent})"
                                    class="w-5 h-5 text-indigo-600 rounded focus:ring-indigo-500 cursor-pointer">
                            </div>

                            <div class="font-bold text-slate-300 w-5 text-center text-xs ${!isPresent ? 'hidden' : ''}">${idx+1}</div>

                            <div>
                                <div class="font-bold text-slate-700 flex items-center gap-2">
                                    ${p.name}
                                    ${isPlaying ? '<span class="text-[8px] bg-indigo-500 text-white px-1.5 py-0.5 rounded-full animate-pulse">PLAYING</span>' : ''}
                                    ${!isPresent ? '<span class="text-[8px] bg-slate-200 text-slate-500 px-1.5 py-0.5 rounded-full">‡πÑ‡∏°‡πà‡∏°‡∏≤</span>' : ''}
                                </div>
                                <div class="text-[10px] text-slate-400">‡πÅ‡∏Ç‡πà‡∏á ${p.matches} | ‡∏ä‡∏ô‡∏∞ ${winRate}%</div>
                            </div>
                        </div>

                        <div class="flex items-center gap-3">
                            <div class="text-right">
                                <div class="font-bold text-indigo-600">${p.score}</div>
                            </div>
                            <button onclick="deletePlayer('${p.id}')" class="admin-only text-slate-300 hover:text-red-500 ml-2">√ó</button>
                        </div>
                    </div>
                `;
            });
        }
    </script>
</body>
</html>
