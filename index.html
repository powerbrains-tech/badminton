<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Badminton Self-Service üè∏</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Kanit', sans-serif; background-color: #f8fafc; }
        
        /* Rank Colors */
        .rank-rookie { border-left: 4px solid #94a3b8; }
        .rank-bronze { border-left: 4px solid #d97706; background: linear-gradient(90deg, #fffbeb 0%, #fff 100%); }
        .rank-silver { border-left: 4px solid #64748b; background: linear-gradient(90deg, #f8fafc 0%, #fff 100%); }
        .rank-gold   { border-left: 4px solid #eab308; background: linear-gradient(90deg, #fefce8 0%, #fff 100%); }
        .rank-diamond{ border-left: 4px solid #0ea5e9; background: linear-gradient(90deg, #f0f9ff 0%, #fff 100%); }
        .rank-master { border-left: 4px solid #a855f7; background: linear-gradient(90deg, #faf5ff 0%, #fff 100%); }

        .admin-only { display: none !important; } 
        .show-admin .admin-only { display: block !important; }
        .show-admin .admin-flex { display: flex !important; }

        /* Modal */
        .modal { transition: opacity 0.25s ease; }
        body.modal-active { overflow-x: hidden; overflow-y: hidden !important; }
    </style>
</head>
<body class="p-4 max-w-2xl mx-auto pb-40">

    <div class="flex justify-between items-center mb-4 sticky top-0 bg-[#f8fafc] z-20 py-2">
        <div>
            <h1 class="text-2xl font-bold text-slate-800">üè∏ Badminton <span class="text-indigo-600">Pro</span></h1>
            
            <button onclick="openIdentityModal()" id="myIdentityBtn" class="text-xs mt-1 bg-white border border-slate-200 px-2 py-1 rounded-full flex items-center gap-1 hover:bg-slate-50 transition shadow-sm">
                <span class="w-2 h-2 rounded-full bg-slate-300" id="idStatus"></span>
                <span id="myName">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏±‡∏ß‡∏ï‡∏ô (‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)</span>
            </button>
        </div>
        
        <div class="flex gap-2">
            <div id="statusIndicator" class="hidden text-[10px] px-2 py-1 rounded bg-gray-200 text-gray-500">...</div>
            <button onclick="toggleAdmin()" class="text-xl p-2 bg-white shadow rounded-full hover:scale-110 transition">üîí</button>
        </div>
    </div>

    <div class="bg-slate-800 text-white p-4 rounded-xl shadow-lg mb-6 admin-only hidden" id="adminPanel">
        <h3 class="font-bold text-sm mb-3 text-slate-300 flex justify-between">
            ‚öôÔ∏è ‡πÅ‡∏ú‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° (Admin)
            <button onclick="resetDay()" class="text-[10px] text-red-300 border border-red-300 px-2 rounded hover:bg-red-500 hover:text-white">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ß‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà</button>
        </h3>
        <div class="flex gap-3 mb-4">
            <select id="courtCount" class="bg-slate-700 rounded px-2 py-1 text-sm flex-1">
                <option value="1">1 ‡∏Ñ‡∏≠‡∏£‡πå‡∏ó</option>
                <option value="2" selected>2 ‡∏Ñ‡∏≠‡∏£‡πå‡∏ó</option>
                <option value="3">3 ‡∏Ñ‡∏≠‡∏£‡πå‡∏ó</option>
            </select>
        </div>
        <button id="btnGenerate" class="w-full bg-indigo-500 hover:bg-indigo-600 py-3 rounded-lg font-bold shadow-lg active:scale-95 transition">
            üöÄ ‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ ‚úÖ)
        </button>
    </div>

    <div id="courtsContainer" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6"></div>

    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4">
        <div class="flex gap-2 mb-4 admin-only hidden" id="addPlayerBox">
            <input type="text" id="inputName" placeholder="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å..." class="flex-1 bg-slate-50 border rounded px-3 py-2 text-sm">
            <button id="btnAdd" class="bg-indigo-600 text-white px-4 rounded font-bold hover:bg-indigo-700">+</button>
        </div>

        <div class="flex p-1 bg-slate-100 rounded-lg mb-4">
            <button onclick="setFilter('all')" id="tab-all" class="flex-1 py-1.5 text-xs font-bold rounded-md bg-white shadow text-indigo-600 transition">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
            <button onclick="setFilter('month')" id="tab-month" class="flex-1 py-1.5 text-xs font-bold rounded-md text-slate-500 hover:bg-white/50 transition">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</button>
            <button onclick="setFilter('day')" id="tab-day" class="flex-1 py-1.5 text-xs font-bold rounded-md text-slate-500 hover:bg-white/50 transition">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
        </div>

        <div class="flex justify-between items-end mb-2 px-2">
            <span class="text-sm font-bold text-slate-700" id="rankTitle">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (MMR)</span>
            <span class="text-[10px] text-slate-400">‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ ‚úÖ</span>
        </div>

        <div id="listContainer" class="space-y-2 pb-10"></div>
    </div>

    <div id="identityModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-md mx-auto rounded shadow-lg z-50 overflow-y-auto max-h-[90vh]">
            <div class="modal-content py-4 text-left px-6">
                <div class="flex justify-between items-center pb-3">
                    <p class="text-xl font-bold">üë§ ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡πÉ‡∏Ñ‡∏£?</p>
                    <div class="modal-close cursor-pointer z-50" onclick="closeIdentityModal()">
                        <svg class="fill-current text-black" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 18 18"><path d="M14.53 4.53l-1.06-1.06L9 7.94 4.53 3.47 3.47 4.53 7.94 9l-4.47 4.47 1.06 1.06L9 10.06l4.47 4.47 1.06-1.06L10.06 9z"></path></svg>
                    </div>
                </div>
                <p class="text-sm text-gray-500 mb-4">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≠‡∏ô‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏Ç‡πà‡∏á</p>
                
                <input type="text" id="searchIdentity" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠..." class="w-full border rounded px-3 py-2 mb-2 text-sm" onkeyup="filterIdentityList()">
                
                <div id="identityList" class="space-y-1 overflow-y-auto max-h-60">
                    </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, setDoc, writeBatch, query, where, orderBy, limit } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        // üî¥üî¥ Config ‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì üî¥üî¥
        const firebaseConfig = {
            apiKey: "AIzaSyC6VSnH2H5zyFPbya0axgP38WiGczYU-oU",
            authDomain: "badminton-smasher-ai.firebaseapp.com",
            projectId: "badminton-smasher-ai",
            storageBucket: "badminton-smasher-ai.firebasestorage.app",
            messagingSenderId: "518167738562",
            appId: "1:518167738562:web:8ba84a7c1a350d16e3e35b",
            measurementId: "G-6X20YG49K9"
        };

        // Game Rules
        const SCORE_WIN = 20;
        const SCORE_DRAW = 5;
        const SCORE_LOSS = -10;

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        const playersRef = collection(db, "players");
        const historyRef = collection(db, "match_history_v2");
        const systemRef = doc(db, "system", "courts_state");

        let playersList = [];
        let activeMatches = [];
        let historyList = [];
        let currentFilter = 'all';
        let myProfile = JSON.parse(localStorage.getItem('badminton_user')) || null;
        let isAdminMode = false;

        // --- Init ---
        updateIdentityUI();

        // --- Listeners ---
        onSnapshot(playersRef, (snapshot) => {
            playersList = [];
            snapshot.forEach(doc => playersList.push({ id: doc.id, ...doc.data() }));
            renderList();
            
            // Check Identity validity
            if (myProfile && !playersList.find(p => p.id === myProfile.id)) {
                logoutIdentity(); // ‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏î‡∏ô‡∏•‡∏ö‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß
            }
        });

        onSnapshot(systemRef, (docSnap) => {
            if (docSnap.exists()) activeMatches = docSnap.data().matches || [];
            else activeMatches = [];
            renderCourts();
        });

        const qHistory = query(historyRef, orderBy("timestamp", "desc"), limit(2000));
        onSnapshot(qHistory, (snapshot) => {
            historyList = [];
            snapshot.forEach(doc => historyList.push(doc.data()));
            renderList();
        });

        // --- Identity System ---
        window.openIdentityModal = () => {
            const modal = document.getElementById('identityModal');
            modal.classList.remove('opacity-0', 'pointer-events-none');
            document.body.classList.add('modal-active');
            renderIdentityList();
        }

        window.closeIdentityModal = () => {
            const modal = document.getElementById('identityModal');
            modal.classList.add('opacity-0', 'pointer-events-none');
            document.body.classList.remove('modal-active');
        }

        window.renderIdentityList = () => {
            const list = document.getElementById('identityList');
            const search = document.getElementById('searchIdentity').value.toLowerCase();
            list.innerHTML = '';
            
            // Filter players
            const filtered = playersList.filter(p => p.name.toLowerCase().includes(search));
            
            if(myProfile) {
                list.innerHTML += `
                    <button onclick="logoutIdentity()" class="w-full text-left px-4 py-2 text-red-500 font-bold border border-red-200 rounded hover:bg-red-50 mb-2">
                        ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö (${myProfile.name})
                    </button>
                `;
            }

            filtered.sort((a,b) => a.name.localeCompare(b.name)).forEach(p => {
                const isActive = myProfile && myProfile.id === p.id;
                list.innerHTML += `
                    <button onclick="selectIdentity('${p.id}', '${p.name}')" class="w-full text-left px-4 py-3 rounded border ${isActive ? 'bg-indigo-50 border-indigo-500 text-indigo-700' : 'bg-white border-slate-100 hover:bg-slate-50'}">
                        ${p.name} ${isActive ? '‚úÖ' : ''}
                    </button>
                `;
            });
        }

        window.filterIdentityList = renderIdentityList;

        window.selectIdentity = (id, name) => {
            myProfile = { id, name };
            localStorage.setItem('badminton_user', JSON.stringify(myProfile));
            updateIdentityUI();
            closeIdentityModal();
            renderCourts(); // Re-render to show buttons
        }

        window.logoutIdentity = () => {
            myProfile = null;
            localStorage.removeItem('badminton_user');
            updateIdentityUI();
            closeIdentityModal();
            renderCourts();
        }

        function updateIdentityUI() {
            const nameEl = document.getElementById('myName');
            const statusEl = document.getElementById('idStatus');
            if (myProfile) {
                nameEl.innerText = myProfile.name;
                nameEl.className = "font-bold text-indigo-700";
                statusEl.className = "w-2 h-2 rounded-full bg-green-500";
            } else {
                nameEl.innerText = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏±‡∏ß‡∏ï‡∏ô (‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)";
                nameEl.className = "text-slate-500";
                statusEl.className = "w-2 h-2 rounded-full bg-slate-300";
            }
        }

        // --- Render Courts (Logic ‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç) ---
        function renderCourts() {
            const container = document.getElementById('courtsContainer');
            container.innerHTML = '';
            activeMatches.sort((a, b) => a.courtNo - b.courtNo);

            if (activeMatches.length === 0) {
                container.innerHTML = `<div class="text-center text-slate-400 py-6 col-span-full border-2 border-dashed border-slate-200 rounded-xl">‡∏™‡∏ô‡∏≤‡∏°‡∏ß‡πà‡∏≤‡∏á...</div>`;
                return;
            }

            activeMatches.forEach(m => {
                // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ "‡∏â‡∏±‡∏ô" ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÅ‡∏°‡∏ï‡∏ä‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏´‡∏°?
                let amIPlaying = false;
                if (myProfile) {
                    const allPlayers = [...m.teamA, ...m.teamB];
                    amIPlaying = allPlayers.some(p => p.id === myProfile.id);
                }

                // ‡∏õ‡∏∏‡πà‡∏°‡∏à‡∏∞‡πÇ‡∏ä‡∏ß‡πå‡∏Å‡πá‡∏ï‡πà‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠: 1. ‡πÄ‡∏õ‡πá‡∏ô Admin ‡∏´‡∏£‡∏∑‡∏≠ 2. ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡πÅ‡∏Ç‡πà‡∏á‡πÉ‡∏ô‡πÅ‡∏°‡∏ï‡∏ä‡πå‡∏ô‡∏±‡πâ‡∏ô
                const showControls = isAdminMode || amIPlaying;
                const controlClass = showControls ? '' : 'hidden'; // ‡πÉ‡∏ä‡πâ hidden ‡∏ã‡πà‡∏≠‡∏ô‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå

                // Special UI for user playing
                const borderClass = amIPlaying ? 'ring-4 ring-yellow-400' : '';

                container.innerHTML += `
                    <div class="rounded-xl p-1 shadow-lg text-white bg-gradient-to-br from-slate-700 to-slate-800 court-card relative ${borderClass}">
                        <div class="absolute top-2 left-2 bg-white/20 px-2 rounded text-xs font-bold">Court ${m.courtNo}</div>
                        ${amIPlaying ? '<div class="absolute top-2 right-12 bg-yellow-400 text-black px-2 rounded text-[10px] font-bold animate-pulse">‡∏Ñ‡∏¥‡∏ß‡∏Ñ‡∏∏‡∏ì!</div>' : ''}
                        
                        <button onclick="cancelMatch(${m.id})" class="absolute top-2 right-2 text-white/50 hover:text-white text-xs admin-only">‚úñ</button>
                        
                        <div class="bg-white rounded-lg p-3 text-slate-800 mt-8">
                            <div class="flex justify-between items-center mb-1 p-1 rounded hover:bg-indigo-50 border-l-4 border-indigo-500">
                                <div class="text-sm font-bold leading-tight pl-2">${m.teamA[0].name}<br>${m.teamA[1].name}</div>
                                <button onclick="finishMatch(${m.id}, 'A_WIN')" class="${controlClass} bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full text-xs font-bold hover:bg-indigo-200 shadow-sm border border-indigo-200">A ‡∏ä‡∏ô‡∏∞</button>
                            </div>
                            
                            <div class="flex justify-center my-1">
                                <button onclick="finishMatch(${m.id}, 'DRAW')" class="${controlClass} bg-slate-100 text-slate-500 px-4 py-0.5 rounded-full text-[10px] font-bold hover:bg-slate-200 border border-slate-300">‡πÄ‡∏™‡∏°‡∏≠</button>
                            </div>

                            <div class="flex justify-between items-center mt-1 p-1 rounded hover:bg-orange-50 border-l-4 border-orange-500">
                                <div class="text-sm font-bold leading-tight pl-2">${m.teamB[0].name}<br>${m.teamB[1].name}</div>
                                <button onclick="finishMatch(${m.id}, 'B_WIN')" class="${controlClass} bg-orange-100 text-orange-700 px-3 py-1 rounded-full text-xs font-bold hover:bg-orange-200 shadow-sm border border-orange-200">B ‡∏ä‡∏ô‡∏∞</button>
                            </div>
                            
                            ${!showControls ? '<div class="text-center text-[10px] text-slate-300 mt-2">‡∏£‡∏≠‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô...</div>' : ''}
                        </div>
                    </div>
                `;
            });
        }

        // --- Logic Functions ---
        
        function calculateStats(player, filter) {
            if (filter === 'all') return { value: player.score, label: 'MMR', displayClass: 'text-slate-800' };
            const now = new Date();
            let cutoff = new Date();
            if (filter === 'day') cutoff.setHours(0,0,0,0);
            if (filter === 'month') { cutoff.setDate(1); cutoff.setHours(0,0,0,0); }

            const timestampCutoff = cutoff.getTime();
            const relevantMatches = historyList.filter(m => m.timestamp >= timestampCutoff);
            
            let netChange = 0;
            let wins = 0, draws = 0, losses = 0;

            relevantMatches.forEach(m => {
                let change = 0;
                if (m.teamA_ids.includes(player.id)) change = m.change_A;
                else if (m.teamB_ids.includes(player.id)) change = m.change_B;
                
                if (change !== 0) {
                    netChange += change;
                    if (change > 0 && change >= SCORE_WIN) wins++;
                    else if (change < 0) losses++;
                    else draws++;
                }
            });

            let label = netChange > 0 ? `+${netChange}` : `${netChange}`;
            let displayClass = netChange > 0 ? 'text-green-600' : (netChange < 0 ? 'text-red-500' : 'text-slate-400');
            return { value: netChange, label, displayClass, wins, draws, losses };
        }

        function getRankTier(score) {
            if (score >= 2000) return { name: 'GRAND MASTER üî•', color: 'rank-master', text: 'text-purple-600' };
            if (score >= 1800) return { name: 'DIAMOND üíé', color: 'rank-diamond', text: 'text-sky-500' };
            if (score >= 1500) return { name: 'GOLD ü•á', color: 'rank-gold', text: 'text-yellow-500' };
            if (score >= 1300) return { name: 'SILVER ü•à', color: 'rank-silver', text: 'text-slate-500' };
            if (score >= 1100) return { name: 'BRONZE ü•â', color: 'rank-bronze', text: 'text-orange-500' };
            return { name: 'ROOKIE üê£', color: 'rank-rookie', text: 'text-slate-400' };
        }

        document.getElementById('btnAdd').onclick = async () => {
            const name = document.getElementById('inputName').value.trim();
            if (!name) return;
            if(playersList.some(p => p.name == name)) { alert('‡∏ä‡∏∑‡πà‡∏≠‡∏ã‡πâ‡∏≥!'); return; }
            await addDoc(playersRef, { name: name, score: 1000, matches: 0, wins: 0, draws: 0, losses: 0, isPresent: true, createdAt: Date.now() });
            document.getElementById('inputName').value = '';
        };

        window.togglePresence = async (id, currentStatus) => {
            await updateDoc(doc(db, "players", id), { isPresent: !currentStatus });
        }

        window.resetDay = async () => {
            if(!confirm("‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠?")) return;
            const batch = writeBatch(db);
            playersList.forEach(p => batch.update(doc(db, "players", p.id), { isPresent: false }));
            await batch.commit();
        }
        
        window.deletePlayer = async (id) => {
             if(confirm("‡∏•‡∏ö‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡∏ñ‡∏≤‡∏ß‡∏£?")) await deleteDoc(doc(db, "players", id));
        }

        document.getElementById('btnGenerate').onclick = async () => {
            const maxCourts = parseInt(document.getElementById('courtCount').value);
            const slots = maxCourts - activeMatches.length;
            if (slots <= 0) return alert("‡∏Ñ‡∏≠‡∏£‡πå‡∏ó‡πÄ‡∏ï‡πá‡∏°!");

            const playingIds = new Set();
            activeMatches.forEach(m => {
                m.teamA.forEach(p => playingIds.add(p.id));
                m.teamB.forEach(p => playingIds.add(p.id));
            });

            let pool = playersList.filter(p => p.isPresent && !playingIds.has(p.id));
            if (pool.length < 4) return alert("‡∏Ñ‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠!");
            
            pool.sort((a, b) => a.matches - b.matches || 0.5 - Math.random());

            const newMatches = [...activeMatches];
            for (let i = 0; i < slots; i++) {
                if (pool.length < 4) break;
                let sel = pool.slice(0, 4);
                pool = pool.slice(4);
                sel.sort((a, b) => b.score - a.score);
                newMatches.push({
                    id: Date.now() + i,
                    courtNo: findNextCourtNo(newMatches),
                    teamA: [sel[0], sel[3]],
                    teamB: [sel[1], sel[2]],
                    startTime: Date.now()
                });
            }
            await setDoc(systemRef, { matches: newMatches });
        };

        function findNextCourtNo(list) {
            const used = new Set(list.map(m => m.courtNo));
            let i = 1; while(used.has(i)) i++; return i;
        }

        window.finishMatch = async (matchId, result) => {
            const msg = result === 'DRAW' ? '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ú‡∏• ‡πÄ‡∏™‡∏°‡∏≠?' : `‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ó‡∏µ‡∏° ${result === 'A_WIN' ? 'A' : 'B'} ‡∏ä‡∏ô‡∏∞?`;
            if (!confirm(msg)) return;

            const match = activeMatches.find(m => m.id === matchId);
            if (!match) return;

            const batch = writeBatch(db);
            let changeA = 0, changeB = 0;

            if (result === 'A_WIN') { changeA = SCORE_WIN; changeB = SCORE_LOSS; }
            else if (result === 'B_WIN') { changeA = SCORE_LOSS; changeB = SCORE_WIN; }
            else { changeA = SCORE_DRAW; changeB = SCORE_DRAW; }

            [...match.teamA, ...match.teamB].forEach(p => {
                const isA = match.teamA.some(x => x.id === p.id);
                const change = isA ? changeA : changeB;
                const ref = doc(db, "players", p.id);
                const curr = playersList.find(x => x.id === p.id);
                if(curr) {
                    const newScore = Math.max(0, curr.score + change);
                    const wins = curr.wins + ((isA && result==='A_WIN') || (!isA && result==='B_WIN') ? 1 : 0);
                    const draws = (curr.draws || 0) + (result === 'DRAW' ? 1 : 0);
                    const losses = (curr.losses || 0) + (change < 0 ? 1 : 0);
                    batch.update(ref, { score: newScore, matches: curr.matches + 1, wins, draws, losses });
                }
            });

            const historyDoc = doc(historyRef);
            batch.set(historyDoc, {
                timestamp: Date.now(),
                result_type: result,
                teamA_ids: match.teamA.map(p => p.id),
                teamB_ids: match.teamB.map(p => p.id),
                change_A: changeA,
                change_B: changeB
            });

            const remaining = activeMatches.filter(m => m.id !== matchId);
            batch.set(systemRef, { matches: remaining });
            await batch.commit();
        };

        window.cancelMatch = async (matchId) => {
            if(!confirm("‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å?")) return;
            const remaining = activeMatches.filter(m => m.id !== matchId);
            await setDoc(systemRef, { matches: remaining });
        }

        window.setFilter = (filter) => {
            currentFilter = filter;
            ['all','month','day'].forEach(f => {
                const btn = document.getElementById(`tab-${f}`);
                if(f === filter) btn.className = "flex-1 py-1.5 text-xs font-bold rounded-md bg-white shadow text-indigo-600 transition";
                else btn.className = "flex-1 py-1.5 text-xs font-bold rounded-md text-slate-500 hover:bg-white/50 transition";
            });
            const titles = { all: "‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (MMR)", month: "‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ (‡πÅ‡∏ï‡πâ‡∏°)", day: "‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (‡πÅ‡∏ï‡πâ‡∏°)" };
            document.getElementById('rankTitle').innerText = titles[filter];
            renderList();
        }

        function renderList() {
            const list = document.getElementById('listContainer');
            list.innerHTML = '';
            
            let displayList = playersList.map(p => {
                const stats = calculateStats(p, currentFilter);
                return { ...p, ...stats };
            });

            displayList.sort((a, b) => b.value - a.value);

            const playingIds = new Set();
            activeMatches.forEach(m => { m.teamA.forEach(p => playingIds.add(p.id)); m.teamB.forEach(p => playingIds.add(p.id)); });

            displayList.forEach((p, idx) => {
                if (currentFilter !== 'all' && p.value === 0) return;

                const rankInfo = getRankTier(p.score);
                const isPlaying = playingIds.has(p.id);

                list.innerHTML += `
                    <div class="flex justify-between items-center p-3 rounded-lg border border-slate-100 mb-2 ${rankInfo.color} ${!p.isPresent ? 'opacity-50 bg-slate-50 grayscale' : 'bg-white'} relative">
                        <div class="flex items-center gap-3">
                            <div class="admin-only">
                                <input type="checkbox" ${p.isPresent ? 'checked' : ''} onchange="togglePresence('${p.id}', ${p.isPresent})" class="w-4 h-4 rounded text-indigo-600 cursor-pointer">
                            </div>
                            <div class="font-bold text-slate-400 w-5 text-center text-sm">${idx+1}</div>
                            <div>
                                <div class="font-bold text-slate-700 flex items-center gap-2">
                                    ${p.name}
                                    ${isPlaying ? '<span class="text-[8px] bg-indigo-500 text-white px-1.5 rounded animate-pulse">PLAYING</span>' : ''}
                                </div>
                                <div class="text-[10px] ${rankInfo.text} font-bold tracking-wide flex gap-2">
                                    ${rankInfo.name} 
                                    <span class="text-slate-400 font-normal">| W:${p.wins || 0} D:${p.draws || 0} L:${p.losses || 0}</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <div class="text-right">
                                <div class="font-bold text-lg ${p.displayClass}">${p.label}</div>
                                <div class="text-[10px] text-slate-400">‡πÅ‡∏Ç‡πà‡∏á ${p.matches}</div>
                            </div>
                            <button onclick="deletePlayer('${p.id}')" class="admin-only text-slate-300 hover:text-red-500 text-xl px-2">√ó</button>
                        </div>
                    </div>
                `;
            });

            if(list.innerHTML === '') list.innerHTML = `<div class="text-center text-sm text-slate-400 py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>`;
        }

        window.toggleAdmin = function() {
            if(isAdminMode) {
                // Logout
                isAdminMode = false;
                document.body.classList.remove('show-admin');
                const panel = document.getElementById('adminPanel');
                const addBox = document.getElementById('addPlayerBox');
                panel.classList.add('hidden'); 
                addBox.classList.add('hidden');
                renderCourts(); // Re-render to hide delete/cancel buttons
            } else {
                // Login
                const pass = prompt("Admin Password:");
                if (pass === "1234") { 
                    isAdminMode = true;
                    document.body.classList.add('show-admin');
                    const panel = document.getElementById('adminPanel');
                    const addBox = document.getElementById('addPlayerBox');
                    panel.classList.remove('hidden'); 
                    addBox.classList.remove('hidden');
                    renderCourts(); // Re-render to show controls
                }
            }
        }
    </script>
</body>
</html>
