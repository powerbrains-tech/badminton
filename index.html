<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Badminton Multi-Court üèüÔ∏è</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Kanit', sans-serif; background-color: #f8fafc; }
        .court-card { transition: all 0.3s; }
        .court-1 { background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%); } /* ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß */
        .court-2 { background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%); } /* ‡∏ü‡πâ‡∏≤ */
        .court-3 { background: linear-gradient(135deg, #f472b6 0%, #db2777 100%); } /* ‡∏ä‡∏°‡∏û‡∏π */
        .court-default { background: linear-gradient(135deg, #94a3b8 0%, #64748b 100%); }
        
        /* Admin controls */
        .admin-only { display: none !important; } 
        .show-admin .admin-only { display: block !important; }
        .show-admin .admin-flex { display: flex !important; }
    </style>
</head>
<body class="p-4 max-w-2xl mx-auto pb-32">

    <div class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-2xl font-bold text-slate-800">üè∏ Badminton <span class="text-indigo-600 text-sm align-top">Pro</span></h1>
            <div id="statusIndicator" class="text-[10px] inline-block px-2 py-0.5 rounded bg-gray-200 text-gray-500">Connecting...</div>
        </div>
        <button onclick="toggleAdmin()" class="text-xl p-2 hover:bg-slate-100 rounded-full transition">üîí</button>
    </div>

    <div class="bg-slate-800 text-white p-4 rounded-xl shadow-lg mb-6 admin-only hidden" id="adminPanel">
        <h3 class="font-bold text-sm mb-2 text-slate-300">‚öôÔ∏è ‡πÅ‡∏ú‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° (Admin)</h3>
        <div class="flex items-center gap-3 mb-3">
            <span class="text-sm">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏≠‡∏£‡πå‡∏ó:</span>
            <select id="courtCount" class="bg-slate-700 border border-slate-600 rounded px-2 py-1 text-sm outline-none">
                <option value="1">1 ‡∏Ñ‡∏≠‡∏£‡πå‡∏ó</option>
                <option value="2" selected>2 ‡∏Ñ‡∏≠‡∏£‡πå‡∏ó</option>
                <option value="3">3 ‡∏Ñ‡∏≠‡∏£‡πå‡∏ó</option>
                <option value="4">4 ‡∏Ñ‡∏≠‡∏£‡πå‡∏ó</option>
            </select>
        </div>
        <button id="btnGenerate" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white py-2 rounded-lg font-bold shadow active:scale-95 transition">
            üé≤ ‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏•‡∏á‡∏™‡∏ô‡∏≤‡∏° (Auto Fill)
        </button>
        <p class="text-[10px] text-slate-400 mt-2 text-center">*‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡∏ô‡∏•‡∏á‡∏Ñ‡∏≠‡∏£‡πå‡∏ó‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡πá‡∏°*</p>
    </div>

    <div id="courtsContainer" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
        </div>

    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4">
        <div class="flex gap-2 mb-4 admin-only hidden" id="addPlayerBox">
            <input type="text" id="inputName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô..." class="flex-1 bg-slate-50 border rounded px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-500">
            <button id="btnAdd" class="bg-indigo-600 text-white px-4 rounded font-bold hover:bg-indigo-700">+</button>
        </div>

        <div class="flex justify-between items-end mb-2 px-1">
            <span class="text-sm font-bold text-slate-700">‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (<span id="playerCount">0</span>)</span>
            <span class="text-[10px] text-slate-400">Score | Win Rate</span>
        </div>
        <div id="listContainer" class="space-y-2">
            </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        // ------------------------------------------------------------------
        // ‚úÖ ‡∏ú‡∏°‡πÉ‡∏™‡πà Config ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö (‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô)
        const firebaseConfig = {
            apiKey: "AIzaSyC6VSnH2H5zyFPbya0axgP38WiGczYU-oU",
            authDomain: "badminton-smasher-ai.firebaseapp.com",
            projectId: "badminton-smasher-ai",
            storageBucket: "badminton-smasher-ai.firebasestorage.app",
            messagingSenderId: "518167738562",
            appId: "1:518167738562:web:8ba84a7c1a350d16e3e35b",
            measurementId: "G-6X20YG49K9"
        };
        // ------------------------------------------------------------------

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // Admin Logic
        window.toggleAdmin = function() {
            const body = document.body;
            if (body.classList.contains('show-admin')) {
                body.classList.remove('show-admin');
                document.getElementById('adminPanel').classList.remove('block');
                document.getElementById('addPlayerBox').classList.remove('flex');
            } else {
                const pass = prompt("Admin Password:");
                if (pass === "1234") { // ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô
                    body.classList.add('show-admin');
                    document.getElementById('adminPanel').classList.remove('hidden');
                    document.getElementById('adminPanel').classList.add('block');
                    document.getElementById('addPlayerBox').classList.remove('hidden');
                    document.getElementById('addPlayerBox').classList.add('flex');
                }
            }
        }

        const playersRef = collection(db, "players");
        const systemRef = doc(db, "system", "courts_state"); // Use new doc for multi-court

        let playersList = [];
        let activeMatches = [];

        // 1. Listen Players
        onSnapshot(playersRef, (snapshot) => {
            document.getElementById('statusIndicator').innerText = "Online üü¢";
            document.getElementById('statusIndicator').className = "text-[10px] inline-block px-2 py-0.5 rounded bg-green-100 text-green-700";
            playersList = [];
            snapshot.forEach(doc => playersList.push({ id: doc.id, ...doc.data() }));
            playersList.sort((a, b) => b.score - a.score);
            renderList();
        });

        // 2. Listen Courts System
        onSnapshot(systemRef, (docSnap) => {
            if (docSnap.exists()) {
                activeMatches = docSnap.data().matches || [];
                renderCourts();
            } else {
                activeMatches = [];
                renderCourts();
            }
        });

        // Add Player
        document.getElementById('btnAdd').onclick = async () => {
            const name = document.getElementById('inputName').value.trim();
            if (!name) return;
            if(playersList.some(p => p.name == name)) { alert('‡∏ä‡∏∑‡πà‡∏≠‡∏ã‡πâ‡∏≥!'); return; }
            await addDoc(playersRef, { name: name, score: 1000, matches: 0, wins: 0, createdAt: Date.now() });
            document.getElementById('inputName').value = '';
        };

        window.deletePlayer = async (id) => {
            if(confirm("‡∏•‡∏ö‡∏ä‡∏∑‡πà‡∏≠?")) await deleteDoc(doc(db, "players", id));
        }

        // --- Multi-Court Logic ---
        document.getElementById('btnGenerate').onclick = async () => {
            const maxCourts = parseInt(document.getElementById('courtCount').value);
            const currentMatchesCount = activeMatches.length;
            const slotsAvailable = maxCourts - currentMatchesCount;

            if (slotsAvailable <= 0) return alert("‡∏Ñ‡∏≠‡∏£‡πå‡∏ó‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö (‡∏ï‡πâ‡∏≠‡∏á‡∏à‡∏ö‡πÄ‡∏Å‡∏°‡∏Å‡πà‡∏≠‡∏ô)");
            
            // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ñ‡∏ô‡πÄ‡∏•‡πà‡∏ô: ‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô activeMatches
            const playingIds = new Set();
            activeMatches.forEach(m => {
                m.teamA.forEach(p => playingIds.add(p.id));
                m.teamB.forEach(p => playingIds.add(p.id));
            });

            // ‡∏´‡∏≤‡∏Ñ‡∏ô‡∏ß‡πà‡∏≤‡∏á
            let availablePlayers = playersList.filter(p => !playingIds.has(p.id));

            if (availablePlayers.length < 4) return alert(`‡∏Ñ‡∏ô‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏°‡πà‡∏û‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏Ñ‡∏≠‡∏£‡πå‡∏ó‡πÉ‡∏´‡∏°‡πà (‡∏ß‡πà‡∏≤‡∏á ${availablePlayers.length} ‡∏Ñ‡∏ô)`);

            // Sort ‡∏Ñ‡∏ô‡∏ß‡πà‡∏≤‡∏á‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏°‡∏ï‡∏ä‡πå‡∏ô‡πâ‡∏≠‡∏¢‡∏™‡∏∏‡∏î
            availablePlayers.sort((a, b) => a.matches - b.matches || 0.5 - Math.random());

            // ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡∏≠‡∏£‡πå‡∏ó‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡πá‡∏°
            const newMatches = [...activeMatches];
            
            // Loop ‡πÄ‡∏õ‡∏¥‡∏î‡∏Ñ‡∏≠‡∏£‡πå‡∏ó‡πÉ‡∏´‡∏°‡πà
            for (let i = 0; i < slotsAvailable; i++) {
                if (availablePlayers.length < 4) break;

                // ‡∏î‡∏∂‡∏á 4 ‡∏Ñ‡∏ô
                let selected = availablePlayers.slice(0, 4);
                // ‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å pool
                availablePlayers = availablePlayers.slice(4);

                // ‡∏à‡∏±‡∏î‡∏ó‡∏µ‡∏° Balance
                selected.sort((a, b) => b.score - a.score);
                const matchObj = {
                    id: Date.now() + i, // Unique ID for match
                    courtNo: findNextCourtNo(newMatches),
                    teamA: [selected[0], selected[3]],
                    teamB: [selected[1], selected[2]],
                    startTime: Date.now()
                };
                newMatches.push(matchObj);
            }

            // Save
            await setDoc(systemRef, { matches: newMatches });
        };

        function findNextCourtNo(currentList) {
            // ‡∏´‡∏≤‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏≠‡∏£‡πå‡∏ó‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà (‡πÄ‡∏ä‡πà‡∏ô 1 ‡∏ß‡πà‡∏≤‡∏á, 2 ‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á -> ‡πÉ‡∏ä‡πâ 1)
            const usedNos = new Set(currentList.map(m => m.courtNo));
            let i = 1;
            while (usedNos.has(i)) i++;
            return i;
        }

        // Finish Specific Match
        window.finishMatch = async (matchId, winnerTeam) => {
            if (!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ó‡∏µ‡∏° ${winnerTeam} ‡∏ä‡∏ô‡∏∞?`)) return;

            const match = activeMatches.find(m => m.id === matchId);
            if (!match) return;

            const winners = winnerTeam === 'A' ? match.teamA : match.teamB;
            const losers = winnerTeam === 'A' ? match.teamB : match.teamA;
            const updatePromises = [];

            // Update Score
            winners.forEach(p => {
                const curr = playersList.find(x => x.id === p.id);
                if(curr) updatePromises.push(updateDoc(doc(db, "players", p.id), { score: curr.score + 20, matches: curr.matches + 1, wins: curr.wins + 1 }));
            });
            losers.forEach(p => {
                const curr = playersList.find(x => x.id === p.id);
                if(curr) updatePromises.push(updateDoc(doc(db, "players", p.id), { score: Math.max(0, curr.score + 5), matches: curr.matches + 1 }));
            });

            await Promise.all(updatePromises);

            // Remove match from array
            const remainingMatches = activeMatches.filter(m => m.id !== matchId);
            await setDoc(systemRef, { matches: remainingMatches });
        };

        window.cancelMatch = async (matchId) => {
            if(!confirm("‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Ñ‡∏≠‡∏£‡πå‡∏ó‡∏ô‡∏µ‡πâ?")) return;
            const remainingMatches = activeMatches.filter(m => m.id !== matchId);
            await setDoc(systemRef, { matches: remainingMatches });
        }

        // Render Functions
        function renderCourts() {
            const container = document.getElementById('courtsContainer');
            container.innerHTML = '';

            // Sort by Court No
            activeMatches.sort((a, b) => a.courtNo - b.courtNo);

            if (activeMatches.length === 0) {
                container.innerHTML = `<div class="text-center text-slate-400 py-8 col-span-full">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô (‡∏Å‡∏î‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏ó‡∏µ‡πà Admin)</div>`;
                return;
            }

            activeMatches.forEach(m => {
                // Color class based on court number (Just for fun)
                let colorClass = 'court-default';
                if (m.courtNo === 1) colorClass = 'court-1';
                if (m.courtNo === 2) colorClass = 'court-2';
                if (m.courtNo === 3) colorClass = 'court-3';

                container.innerHTML += `
                    <div class="rounded-xl p-1 shadow-lg text-white relative ${colorClass} court-card">
                        <div class="flex justify-between items-center px-2 py-1">
                            <span class="font-bold text-xs bg-black/20 px-2 rounded">Court ${m.courtNo}</span>
                            <button onclick="cancelMatch(${m.id})" class="text-white/60 hover:text-white text-xs admin-only">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                        </div>

                        <div class="bg-white rounded-lg p-3 text-slate-800 mt-1">
                            <div class="flex justify-between items-center mb-2 p-1.5 rounded border border-transparent hover:bg-slate-50">
                                <div>
                                    <div class="font-bold leading-tight">${m.teamA[0].name}</div>
                                    <div class="font-bold leading-tight">${m.teamA[1].name}</div>
                                </div>
                                <button onclick="finishMatch(${m.id}, 'A')" class="admin-only bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full text-xs font-bold hover:bg-indigo-200">A Win</button>
                            </div>

                            <div class="text-center text-[10px] text-slate-300 font-bold">- VS -</div>

                            <div class="flex justify-between items-center mt-2 p-1.5 rounded border border-transparent hover:bg-slate-50">
                                <div>
                                    <div class="font-bold leading-tight">${m.teamB[0].name}</div>
                                    <div class="font-bold leading-tight">${m.teamB[1].name}</div>
                                </div>
                                <button onclick="finishMatch(${m.id}, 'B')" class="admin-only bg-orange-100 text-orange-700 px-3 py-1 rounded-full text-xs font-bold hover:bg-orange-200">B Win</button>
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        function renderList() {
            const list = document.getElementById('listContainer');
            document.getElementById('playerCount').innerText = playersList.length;
            list.innerHTML = '';
            
            // Check who is playing
            const playingIds = new Set();
            activeMatches.forEach(m => {
                m.teamA.forEach(p => playingIds.add(p.id));
                m.teamB.forEach(p => playingIds.add(p.id));
            });

            playersList.forEach((p, idx) => {
                const isPlaying = playingIds.has(p.id);
                const winRate = p.matches ? Math.round((p.wins/p.matches)*100) : 0;
                
                list.innerHTML += `
                    <div class="flex justify-between items-center bg-white p-2 rounded border border-slate-100 ${isPlaying ? 'opacity-50 grayscale bg-slate-50' : ''}">
                        <div class="flex items-center gap-3">
                            <div class="font-bold text-slate-300 w-4 text-center text-xs">${idx+1}</div>
                            <div>
                                <div class="font-bold text-slate-700 text-sm flex items-center gap-2">
                                    ${p.name}
                                    ${isPlaying ? '<span class="text-[8px] bg-green-100 text-green-600 px-1 rounded">PLAYING</span>' : ''}
                                </div>
                                <div class="text-[10px] text-slate-400">‡πÅ‡∏Ç‡πà‡∏á ${p.matches}</div>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <div class="text-right">
                                <div class="font-bold text-indigo-600 text-sm">${p.score}</div>
                                <div class="text-[10px] text-slate-400">${winRate}%</div>
                            </div>
                            <button onclick="deletePlayer('${p.id}')" class="admin-only text-red-200 hover:text-red-500 ml-1 text-lg leading-none">√ó</button>
                        </div>
                    </div>
                `;
            });
        }
    </script>
</body>
</html>
