<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Badminton Real-time ‚ö°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Kanit', sans-serif; background-color: #f8fafc; }
        .rank-novice { background-color: #f1f5f9; color: #64748b; }
        .rank-gold { background: linear-gradient(135deg, #fcd34d 0%, #f59e0b 100%); color: white; }
        .court-active { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(79, 70, 229, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(79, 70, 229, 0); } 100% { box-shadow: 0 0 0 0 rgba(79, 70, 229, 0); } }
    </style>
</head>
<body class="p-4 max-w-md mx-auto pb-20">

    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold text-slate-800">üè∏ Badminton <span class="text-indigo-600 text-sm align-top">Live</span></h1>
        <div id="statusIndicator" class="text-xs px-2 py-1 rounded bg-gray-200 text-gray-500">Connecting...</div>
    </div>

    <div id="matchSection" class="hidden mb-6">
        <div class="bg-indigo-600 rounded-xl p-1 shadow-lg court-active relative">
             <div class="text-center text-white text-xs font-bold py-1">LIVE MATCH üî¥</div>
             <button id="cancelBtn" class="absolute top-1 right-2 text-white/50 text-xs hover:text-white">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
             
             <div class="bg-white rounded-lg p-4">
                 <div class="flex justify-between items-center mb-2 p-2 rounded hover:bg-indigo-50 cursor-pointer border border-transparent hover:border-indigo-100" id="btnWinA">
                     <div class="text-left">
                         <div class="font-bold text-lg text-slate-800" id="nameA1">...</div>
                         <div class="font-bold text-lg text-slate-800" id="nameA2">...</div>
                     </div>
                     <div class="bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full text-xs font-bold">‡∏Å‡∏î‡∏ä‡∏ô‡∏∞</div>
                 </div>

                 <div class="text-center text-xs text-slate-300 my-1">- VS -</div>

                 <div class="flex justify-between items-center mt-2 p-2 rounded hover:bg-orange-50 cursor-pointer border border-transparent hover:border-orange-100" id="btnWinB">
                     <div class="text-left">
                         <div class="font-bold text-lg text-slate-800" id="nameB1">...</div>
                         <div class="font-bold text-lg text-slate-800" id="nameB2">...</div>
                     </div>
                     <div class="bg-orange-100 text-orange-700 px-3 py-1 rounded-full text-xs font-bold">‡∏Å‡∏î‡∏ä‡∏ô‡∏∞</div>
                 </div>
             </div>
        </div>
    </div>

    <div class="mb-6">
        <button id="btnGenerate" class="w-full bg-slate-800 text-white py-3 rounded-xl font-bold shadow hover:bg-slate-900 active:scale-95 transition hidden">
            üé≤ ‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡πÄ‡∏•‡πà‡∏ô‡∏£‡∏≠‡∏ö‡∏ï‡πà‡∏≠‡πÑ‡∏õ
        </button>
    </div>

    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4">
        <div class="flex gap-2 mb-4">
            <input type="text" id="inputName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô..." class="flex-1 bg-slate-50 border rounded px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-500">
            <button id="btnAdd" class="bg-indigo-600 text-white px-4 rounded font-bold hover:bg-indigo-700">+</button>
        </div>

        <div class="flex justify-between text-xs text-slate-400 mb-2 px-2">
            <span>‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô (<span id="playerCount">0</span>)</span>
            <span>Score (Win%)</span>
        </div>
        <div id="listContainer" class="space-y-2">
            </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        // ------------------------------------------------------------------
        // ‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç config ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö
        // ------------------------------------------------------------------
        const firebaseConfig = {
            apiKey: "AIzaSyC6VSnH2H5zyFPbya0axgP38WiGczYU-oU",
            authDomain: "badminton-smasher-ai.firebaseapp.com",
            projectId: "badminton-smasher-ai",
            storageBucket: "badminton-smasher-ai.firebasestorage.app",
            messagingSenderId: "518167738562",
            appId: "1:518167738562:web:8ba84a7c1a350d16e3e35b",
            measurementId: "G-6X20YG49K9"
        };
        // ------------------------------------------------------------------

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const statusDiv = document.getElementById('statusIndicator');

        // References
        const playersRef = collection(db, "players");
        const matchRef = doc(db, "system", "current_match");

        let playersList = [];
        let currentMatchData = null;

        // 1. Real-time Listener: Players
        onSnapshot(playersRef, (snapshot) => {
            statusDiv.innerText = "Online üü¢";
            statusDiv.className = "text-xs px-2 py-1 rounded bg-green-100 text-green-700";
            
            playersList = [];
            snapshot.forEach(doc => {
                playersList.push({ id: doc.id, ...doc.data() });
            });

            // Sort logic: Score ‡∏°‡∏≤‡∏Å‡∏™‡∏∏‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô
            playersList.sort((a, b) => b.score - a.score);
            renderList();
        });

        // 2. Real-time Listener: Match
        onSnapshot(matchRef, (docSnap) => {
            if (docSnap.exists()) {
                currentMatchData = docSnap.data();
                if(currentMatchData.active) {
                    renderMatch(currentMatchData);
                } else {
                    hideMatch();
                }
            } else {
                hideMatch();
            }
        });

        // --- Functions ---

        // Add Player
        document.getElementById('btnAdd').onclick = async () => {
            const name = document.getElementById('inputName').value.trim();
            if (!name) return;
            
            // Check duplicate name local check (for speed)
            if(playersList.some(p => p.name == name)) { alert('‡∏ä‡∏∑‡πà‡∏≠‡∏ã‡πâ‡∏≥!'); return; }

            await addDoc(playersRef, {
                name: name,
                score: 1000,
                matches: 0,
                wins: 0,
                createdAt: Date.now()
            });
            document.getElementById('inputName').value = '';
        };

        // Generate Match
        document.getElementById('btnGenerate').onclick = async () => {
            if (playersList.length < 4) return alert('‡∏Ñ‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠ (‡∏ï‡πâ‡∏≠‡∏á 4 ‡∏Ñ‡∏ô)');
            
            // Logic ‡∏à‡∏±‡∏î‡∏ó‡∏µ‡∏° (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
            // 1. ‡∏´‡∏≤ 4 ‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà match ‡∏ô‡πâ‡∏≠‡∏¢‡∏™‡∏∏‡∏î
            let pool = [...playersList].sort((a, b) => a.matches - b.matches || 0.5 - Math.random());
            let selected = pool.slice(0, 4);
            
            // 2. ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Å‡πà‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏ö‡πà‡∏á‡∏Ç‡πâ‡∏≤‡∏á
            selected.sort((a, b) => b.score - a.score);
            
            // Team A: #1 & #4, Team B: #2 & #3
            const matchData = {
                active: true,
                teamA: [selected[0], selected[3]],
                teamB: [selected[1], selected[2]]
            };

            // Save to Firebase (Everyone will see this update immediately)
            await setDoc(matchRef, matchData);
        };

        // Finish Match
        async function finishMatch(winnerTeam) {
            if (!currentMatchData || !currentMatchData.active) return;
            if (!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ó‡∏µ‡∏° ${winnerTeam} ‡∏ä‡∏ô‡∏∞?`)) return;

            const winners = winnerTeam === 'A' ? currentMatchData.teamA : currentMatchData.teamB;
            const losers = winnerTeam === 'A' ? currentMatchData.teamB : currentMatchData.teamA;

            // Update scores in Firebase
            // ‡∏ï‡πâ‡∏≠‡∏á‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ó‡∏µ‡∏•‡∏∞‡∏Ñ‡∏ô
            const updatePromises = [];

            winners.forEach(p => {
                const pRef = doc(db, "players", p.id);
                // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏ß‡∏Å (Best practice) ‡πÅ‡∏ï‡πà‡∏á‡πà‡∏≤‡∏¢‡πÜ ‡∏Ñ‡∏∑‡∏≠‡∏ö‡∏ß‡∏Å‡πÄ‡∏•‡∏¢
                // ‡∏´‡∏≤‡∏Ñ‡πà‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏à‡∏≤‡∏Å local list
                const curr = playersList.find(x => x.id === p.id);
                if(curr) updatePromises.push(updateDoc(pRef, { 
                    score: curr.score + 20, 
                    matches: curr.matches + 1,
                    wins: curr.wins + 1
                }));
            });

            losers.forEach(p => {
                const pRef = doc(db, "players", p.id);
                const curr = playersList.find(x => x.id === p.id);
                if(curr) updatePromises.push(updateDoc(pRef, { 
                    score: Math.max(0, curr.score + 5), 
                    matches: curr.matches + 1
                }));
            });

            await Promise.all(updatePromises);

            // Clear Match
            await setDoc(matchRef, { active: false });
        }

        // Bind Finish Buttons
        document.getElementById('btnWinA').onclick = () => finishMatch('A');
        document.getElementById('btnWinB').onclick = () => finishMatch('B');
        
        document.getElementById('cancelBtn').onclick = async () => {
             if(confirm('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÄ‡∏Å‡∏°‡∏ô‡∏µ‡πâ?')) await setDoc(matchRef, { active: false });
        };

        // Render UI
        function renderList() {
            const list = document.getElementById('listContainer');
            document.getElementById('playerCount').innerText = playersList.length;
            list.innerHTML = '';

            playersList.forEach((p, idx) => {
                const winRate = p.matches ? Math.round((p.wins/p.matches)*100) : 0;
                const isTop = idx < 3;
                
                list.innerHTML += `
                    <div class="flex justify-between items-center bg-white p-3 rounded border ${isTop ? 'border-orange-200 bg-orange-50/30' : 'border-slate-100'}">
                        <div class="flex items-center gap-3">
                            <div class="font-bold text-slate-300 w-4 text-center">${idx+1}</div>
                            <div>
                                <div class="font-bold text-slate-700">${p.name}</div>
                                <div class="text-[10px] text-slate-400">‡πÅ‡∏Ç‡πà‡∏á ${p.matches}</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold text-indigo-600">${p.score}</div>
                            <div class="text-[10px] ${winRate >= 50 ? 'text-green-500' : 'text-slate-400'}">${winRate}% Win</div>
                        </div>
                    </div>
                `;
            });
        }

        function renderMatch(data) {
            document.getElementById('matchSection').classList.remove('hidden');
            document.getElementById('btnGenerate').classList.add('hidden');
            
            document.getElementById('nameA1').innerText = data.teamA[0].name;
            document.getElementById('nameA2').innerText = data.teamA[1].name;
            document.getElementById('nameB1').innerText = data.teamB[0].name;
            document.getElementById('nameB2').innerText = data.teamB[1].name;
        }

        function hideMatch() {
            document.getElementById('matchSection').classList.add('hidden');
            document.getElementById('btnGenerate').classList.remove('hidden');
        }
    </script>
</body>
</html>
