<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Badminton Ranking üèÜ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Kanit', sans-serif; background-color: #f8fafc; }
        
        /* Rank Colors */
        .rank-rookie { border-left: 4px solid #94a3b8; }
        .rank-bronze { border-left: 4px solid #d97706; background: linear-gradient(90deg, #fffbeb 0%, #fff 100%); }
        .rank-silver { border-left: 4px solid #64748b; background: linear-gradient(90deg, #f8fafc 0%, #fff 100%); }
        .rank-gold   { border-left: 4px solid #eab308; background: linear-gradient(90deg, #fefce8 0%, #fff 100%); }
        .rank-diamond{ border-left: 4px solid #0ea5e9; background: linear-gradient(90deg, #f0f9ff 0%, #fff 100%); }
        .rank-master { border-left: 4px solid #a855f7; background: linear-gradient(90deg, #faf5ff 0%, #fff 100%); }

        .admin-only { display: none !important; } 
        .show-admin .admin-only { display: block !important; }
        .show-admin .admin-flex { display: flex !important; }
    </style>
</head>
<body class="p-4 max-w-2xl mx-auto pb-40">

    <div class="flex justify-between items-center mb-4 sticky top-0 bg-[#f8fafc] z-20 py-2">
        <div>
            <h1 class="text-2xl font-bold text-slate-800">üè∏ Ranking <span class="text-indigo-600">Pro</span></h1>
            <div id="statusIndicator" class="text-[10px] inline-block px-2 py-0.5 rounded bg-gray-200 text-gray-500">Connecting...</div>
        </div>
        <button onclick="toggleAdmin()" class="text-xl p-2 bg-white shadow rounded-full hover:scale-110 transition">üîí</button>
    </div>

    <div class="bg-slate-800 text-white p-4 rounded-xl shadow-lg mb-6 admin-only hidden" id="adminPanel">
        <h3 class="font-bold text-sm mb-3 text-slate-300 flex justify-between">
            ‚öôÔ∏è ‡πÅ‡∏ú‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°
            <button onclick="resetDay()" class="text-[10px] text-red-300 border border-red-300 px-2 rounded hover:bg-red-500 hover:text-white">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ß‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà</button>
        </h3>
        <div class="flex gap-3 mb-4">
            <select id="courtCount" class="bg-slate-700 rounded px-2 py-1 text-sm flex-1">
                <option value="1">1 ‡∏Ñ‡∏≠‡∏£‡πå‡∏ó</option>
                <option value="2" selected>2 ‡∏Ñ‡∏≠‡∏£‡πå‡∏ó</option>
                <option value="3">3 ‡∏Ñ‡∏≠‡∏£‡πå‡∏ó</option>
            </select>
        </div>
        <button id="btnGenerate" class="w-full bg-indigo-500 hover:bg-indigo-600 py-3 rounded-lg font-bold shadow-lg active:scale-95 transition">
            üöÄ ‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ ‚úÖ)
        </button>
    </div>

    <div id="courtsContainer" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6"></div>

    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4">
        
        <div class="flex gap-2 mb-4 admin-only hidden" id="addPlayerBox">
            <input type="text" id="inputName" placeholder="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å..." class="flex-1 bg-slate-50 border rounded px-3 py-2 text-sm">
            <button id="btnAdd" class="bg-indigo-600 text-white px-4 rounded font-bold hover:bg-indigo-700">+</button>
        </div>

        <div class="flex p-1 bg-slate-100 rounded-lg mb-4">
            <button onclick="setFilter('all')" id="tab-all" class="flex-1 py-1.5 text-xs font-bold rounded-md bg-white shadow text-indigo-600 transition">‡∏ï‡∏•‡∏≠‡∏î‡∏Å‡∏≤‡∏•</button>
            <button onclick="setFilter('month')" id="tab-month" class="flex-1 py-1.5 text-xs font-bold rounded-md text-slate-500 hover:bg-white/50 transition">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</button>
            <button onclick="setFilter('week')" id="tab-week" class="flex-1 py-1.5 text-xs font-bold rounded-md text-slate-500 hover:bg-white/50 transition">‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå‡∏ô‡∏µ‡πâ</button>
            <button onclick="setFilter('day')" id="tab-day" class="flex-1 py-1.5 text-xs font-bold rounded-md text-slate-500 hover:bg-white/50 transition">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
        </div>

        <div class="flex justify-between items-end mb-2 px-2">
            <span class="text-sm font-bold text-slate-700" id="rankTitle">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏£‡∏ß‡∏° (Score)</span>
            <span class="text-[10px] text-slate-400">‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ‚úÖ</span>
        </div>

        <div id="listContainer" class="space-y-2 pb-10"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, setDoc, writeBatch, query, where, orderBy, limit } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        // ------------------------------------------------------------------
        // üî¥üî¥ ‡πÉ‡∏™‡πà Config ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) üî¥üî¥
        const firebaseConfig = {
            apiKey: "AIzaSyC6VSnH2H5zyFPbya0axgP38WiGczYU-oU",
            authDomain: "badminton-smasher-ai.firebaseapp.com",
            projectId: "badminton-smasher-ai",
            storageBucket: "badminton-smasher-ai.firebasestorage.app",
            messagingSenderId: "518167738562",
            appId: "1:518167738562:web:8ba84a7c1a350d16e3e35b",
            measurementId: "G-6X20YG49K9"
        };
        // ------------------------------------------------------------------

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // References
        const playersRef = collection(db, "players");
        const historyRef = collection(db, "match_history"); // New Collection for Analytics
        const systemRef = doc(db, "system", "courts_state");

        // State
        let playersList = [];
        let activeMatches = [];
        let historyList = [];
        let currentFilter = 'all'; // all, month, week, day

        // --- 1. Real-time Listeners ---
        
        // Listen Players
        onSnapshot(playersRef, (snapshot) => {
            document.getElementById('statusIndicator').innerText = "Online üü¢";
            document.getElementById('statusIndicator').className = "text-[10px] inline-block px-2 py-0.5 rounded bg-green-100 text-green-700";
            playersList = [];
            snapshot.forEach(doc => playersList.push({ id: doc.id, ...doc.data() }));
            renderList();
        });

        // Listen Matches (Active)
        onSnapshot(systemRef, (docSnap) => {
            if (docSnap.exists()) activeMatches = docSnap.data().matches || [];
            else activeMatches = [];
            renderCourts();
        });

        // Listen History (For Ranking) - Listen Last 2000 matches
        const qHistory = query(historyRef, orderBy("timestamp", "desc"), limit(2000));
        onSnapshot(qHistory, (snapshot) => {
            historyList = [];
            snapshot.forEach(doc => historyList.push(doc.data()));
            renderList(); // Re-render when history updates
        });

        // --- 2. Ranking Logic ---

        window.setFilter = (filter) => {
            currentFilter = filter;
            // Update Tab UI
            ['all','month','week','day'].forEach(f => {
                const btn = document.getElementById(`tab-${f}`);
                if(f === filter) {
                    btn.className = "flex-1 py-1.5 text-xs font-bold rounded-md bg-white shadow text-indigo-600 transition";
                } else {
                    btn.className = "flex-1 py-1.5 text-xs font-bold rounded-md text-slate-500 hover:bg-white/50 transition";
                }
            });
            
            // Update Title
            const titles = { all: "‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏£‡∏ß‡∏° (MMR)", month: "‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ (‡πÅ‡∏ï‡πâ‡∏°)", week: "‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå‡∏ô‡∏µ‡πâ (‡πÅ‡∏ï‡πâ‡∏°)", day: "‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (‡πÅ‡∏ï‡πâ‡∏°)" };
            document.getElementById('rankTitle').innerText = titles[filter];
            
            renderList();
        }

        function calculateStats(player, filter) {
            // "All Time" uses the main score field
            if (filter === 'all') return { value: player.score, label: 'MMR' };

            // For periods, we calculate "Net Point Change" from history
            const now = new Date();
            let cutoff = new Date();
            
            if (filter === 'day') cutoff.setHours(0,0,0,0);
            if (filter === 'week') {
                const day = cutoff.getDay() || 7; 
                if(day !== 1) cutoff.setHours(-24 * (day - 1)); 
                else cutoff.setHours(0,0,0,0);
            }
            if (filter === 'month') cutoff.setDate(1); cutoff.setHours(0,0,0,0);

            const timestampCutoff = cutoff.getTime();

            // Filter History
            const relevantMatches = historyList.filter(m => m.timestamp >= timestampCutoff);
            
            let pointChange = 0;
            let wins = 0;
            let matches = 0;

            relevantMatches.forEach(m => {
                if (m.winners.includes(player.id)) {
                    pointChange += 20;
                    wins++;
                    matches++;
                } else if (m.losers.includes(player.id)) {
                    pointChange += 5;
                    matches++;
                }
            });

            return { value: pointChange, label: `+${pointChange} pts`, wins, matches };
        }

        function getRankTier(score) {
            if (score >= 2000) return { name: 'GRAND MASTER üî•', color: 'rank-master', text: 'text-purple-600' };
            if (score >= 1800) return { name: 'DIAMOND üíé', color: 'rank-diamond', text: 'text-sky-500' };
            if (score >= 1500) return { name: 'GOLD ü•á', color: 'rank-gold', text: 'text-yellow-500' };
            if (score >= 1300) return { name: 'SILVER ü•à', color: 'rank-silver', text: 'text-slate-500' };
            if (score >= 1100) return { name: 'BRONZE ü•â', color: 'rank-bronze', text: 'text-orange-500' };
            return { name: 'ROOKIE üê£', color: 'rank-rookie', text: 'text-slate-400' };
        }

        // --- 3. Core Logic (Add/Finish/Match) ---

        document.getElementById('btnAdd').onclick = async () => {
            const name = document.getElementById('inputName').value.trim();
            if (!name) return;
            if(playersList.some(p => p.name == name)) { alert('‡∏ä‡∏∑‡πà‡∏≠‡∏ã‡πâ‡∏≥!'); return; }
            await addDoc(playersRef, { name: name, score: 1000, matches: 0, wins: 0, isPresent: true, createdAt: Date.now() });
            document.getElementById('inputName').value = '';
        };

        window.togglePresence = async (id, currentStatus) => {
            await updateDoc(doc(db, "players", id), { isPresent: !currentStatus });
        }

        window.resetDay = async () => {
            if(!confirm("‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠?")) return;
            const batch = writeBatch(db);
            playersList.forEach(p => batch.update(doc(db, "players", p.id), { isPresent: false }));
            await batch.commit();
        }
        
        window.deletePlayer = async (id) => {
             if(confirm("‡∏•‡∏ö‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡∏ñ‡∏≤‡∏ß‡∏£?")) await deleteDoc(doc(db, "players", id));
        }

        // Generate Match
        document.getElementById('btnGenerate').onclick = async () => {
            const maxCourts = parseInt(document.getElementById('courtCount').value);
            const slots = maxCourts - activeMatches.length;
            if (slots <= 0) return alert("‡∏Ñ‡∏≠‡∏£‡πå‡∏ó‡πÄ‡∏ï‡πá‡∏°!");

            const playingIds = new Set();
            activeMatches.forEach(m => {
                m.teamA.forEach(p => playingIds.add(p.id));
                m.teamB.forEach(p => playingIds.add(p.id));
            });

            // Filter & Sort
            let pool = playersList.filter(p => p.isPresent && !playingIds.has(p.id));
            if (pool.length < 4) return alert("‡∏Ñ‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠!");
            
            pool.sort((a, b) => a.matches - b.matches || 0.5 - Math.random());

            const newMatches = [...activeMatches];
            for (let i = 0; i < slots; i++) {
                if (pool.length < 4) break;
                let sel = pool.slice(0, 4);
                pool = pool.slice(4);
                
                // Balance Teams
                sel.sort((a, b) => b.score - a.score); // ‡πÄ‡∏Å‡πà‡∏á‡∏™‡∏∏‡∏î‡∏≠‡∏¢‡∏π‡πà index 0
                
                newMatches.push({
                    id: Date.now() + i,
                    courtNo: findNextCourtNo(newMatches),
                    teamA: [sel[0], sel[3]],
                    teamB: [sel[1], sel[2]],
                    startTime: Date.now()
                });
            }
            await setDoc(systemRef, { matches: newMatches });
        };

        function findNextCourtNo(list) {
            const used = new Set(list.map(m => m.courtNo));
            let i = 1; while(used.has(i)) i++; return i;
        }

        // Finish Match & SAVE HISTORY
        window.finishMatch = async (matchId, winnerTeam) => {
            if (!confirm(`‡∏ó‡∏µ‡∏° ${winnerTeam} ‡∏ä‡∏ô‡∏∞?`)) return;
            const match = activeMatches.find(m => m.id === matchId);
            if (!match) return;

            const winners = winnerTeam === 'A' ? match.teamA : match.teamB;
            const losers = winnerTeam === 'A' ? match.teamB : match.teamA;
            const batch = writeBatch(db);

            // 1. Update Players
            winners.forEach(p => {
                const ref = doc(db, "players", p.id);
                const curr = playersList.find(x => x.id === p.id);
                batch.update(ref, { score: curr.score + 20, matches: curr.matches + 1, wins: curr.wins + 1 });
            });
            losers.forEach(p => {
                const ref = doc(db, "players", p.id);
                const curr = playersList.find(x => x.id === p.id);
                batch.update(ref, { score: Math.max(0, curr.score + 5), matches: curr.matches + 1 });
            });

            // 2. Save History (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Filter ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)
            const historyDoc = doc(historyRef); // Auto ID
            batch.set(historyDoc, {
                timestamp: Date.now(),
                winners: winners.map(p => p.id),
                losers: losers.map(p => p.id),
                points_winner: 20,
                points_loser: 5
            });

            // 3. Clear Court
            const remaining = activeMatches.filter(m => m.id !== matchId);
            batch.set(systemRef, { matches: remaining });

            await batch.commit();
        };

        window.cancelMatch = async (matchId) => {
            if(!confirm("‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å?")) return;
            const remaining = activeMatches.filter(m => m.id !== matchId);
            await setDoc(systemRef, { matches: remaining });
        }

        // --- Render UI ---

        function renderCourts() {
            const container = document.getElementById('courtsContainer');
            container.innerHTML = '';
            activeMatches.sort((a, b) => a.courtNo - b.courtNo);

            if (activeMatches.length === 0) {
                container.innerHTML = `<div class="text-center text-slate-400 py-6 col-span-full border-2 border-dashed border-slate-200 rounded-xl">‡∏™‡∏ô‡∏≤‡∏°‡∏ß‡πà‡∏≤‡∏á...</div>`;
                return;
            }

            activeMatches.forEach(m => {
                container.innerHTML += `
                    <div class="rounded-xl p-1 shadow-lg text-white bg-gradient-to-br from-indigo-500 to-blue-600 court-card relative">
                        <div class="absolute top-2 left-2 bg-black/20 px-2 rounded text-xs font-bold">Court ${m.courtNo}</div>
                        <button onclick="cancelMatch(${m.id})" class="absolute top-2 right-2 text-white/50 hover:text-white text-xs admin-only">‚úñ</button>
                        
                        <div class="bg-white rounded-lg p-3 text-slate-800 mt-8">
                            <div class="flex justify-between items-center mb-2 p-1 rounded hover:bg-slate-50">
                                <div class="text-sm font-bold leading-tight">${m.teamA[0].name}<br>${m.teamA[1].name}</div>
                                <button onclick="finishMatch(${m.id}, 'A')" class="admin-only bg-green-100 text-green-700 px-3 py-1 rounded-full text-xs font-bold">‡∏ä‡∏ô‡∏∞</button>
                            </div>
                            <div class="text-center text-[10px] text-slate-300 font-bold">- VS -</div>
                            <div class="flex justify-between items-center mt-2 p-1 rounded hover:bg-slate-50">
                                <div class="text-sm font-bold leading-tight">${m.teamB[0].name}<br>${m.teamB[1].name}</div>
                                <button onclick="finishMatch(${m.id}, 'B')" class="admin-only bg-green-100 text-green-700 px-3 py-1 rounded-full text-xs font-bold">‡∏ä‡∏ô‡∏∞</button>
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        function renderList() {
            const list = document.getElementById('listContainer');
            list.innerHTML = '';
            
            // Map data with stats
            let displayList = playersList.map(p => {
                const stats = calculateStats(p, currentFilter);
                return { ...p, ...stats };
            });

            // Sort: Value (Score or Point Change) DESC
            displayList.sort((a, b) => b.value - a.value);

            const playingIds = new Set();
            activeMatches.forEach(m => { m.teamA.forEach(p => playingIds.add(p.id)); m.teamB.forEach(p => playingIds.add(p.id)); });

            displayList.forEach((p, idx) => {
                const rankInfo = getRankTier(p.score); // Rank Tier always based on Total Score
                const isPlaying = playingIds.has(p.id);
                
                // ‡∏ñ‡πâ‡∏≤‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡πÉ‡∏´‡πâ‡πÇ‡∏ä‡∏ß‡πå‡πÅ‡∏Ñ‡πà‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß (value > 0)
                if (currentFilter !== 'all' && p.value === 0) return;

                list.innerHTML += `
                    <div class="flex justify-between items-center p-3 rounded-lg border border-slate-100 mb-2 ${rankInfo.color} ${!p.isPresent ? 'opacity-60 bg-slate-50' : 'bg-white'} relative">
                        <div class="flex items-center gap-3">
                            <div class="admin-only">
                                <input type="checkbox" ${p.isPresent ? 'checked' : ''} onchange="togglePresence('${p.id}', ${p.isPresent})" class="w-4 h-4 rounded text-indigo-600 cursor-pointer">
                            </div>
                            <div class="font-bold text-slate-400 w-5 text-center text-sm">${idx+1}</div>
                            <div>
                                <div class="font-bold text-slate-700 flex items-center gap-2">
                                    ${p.name}
                                    ${isPlaying ? '<span class="text-[8px] bg-indigo-500 text-white px-1.5 rounded animate-pulse">PLAYING</span>' : ''}
                                </div>
                                <div class="text-[10px] ${rankInfo.text} font-bold tracking-wide">${rankInfo.name}</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold text-lg ${currentFilter === 'all' ? 'text-slate-800' : 'text-green-600'}">${currentFilter === 'all' ? p.value : '+' + p.value}</div>
                            <div class="text-[10px] text-slate-400">${currentFilter === 'all' ? (p.matches ? Math.round(p.wins/p.matches*100) : 0) + '% Win' : p.matches + ' ‡πÅ‡∏°‡∏ï‡∏ä‡πå'}</div>
                        </div>
                    </div>
                `;
            });
            
            if(list.innerHTML === '') list.innerHTML = `<div class="text-center text-sm text-slate-400 py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏µ‡πâ</div>`;
        }

        // Admin Toggle
        window.toggleAdmin = function() {
            const pass = prompt("Admin Password:");
            if (pass === "1234") { 
                document.body.classList.toggle('show-admin');
                const panel = document.getElementById('adminPanel');
                const addBox = document.getElementById('addPlayerBox');
                if(panel.classList.contains('hidden')) {
                    panel.classList.remove('hidden'); addBox.classList.remove('hidden');
                } else {
                    panel.classList.add('hidden'); addBox.classList.add('hidden');
                }
            }
        }
    </script>
</body>
</html>
