<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Badminton Pro League üèÜ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Kanit', sans-serif; background-color: #f1f5f9; }
        .card-base { border: 2px solid; transition: all 0.2s; }
        /* Ranks */
        .frame-rookie { border-color: #cbd5e1; background: white; }
        .frame-bronze { border-color: #fbbf24; background: linear-gradient(to right, #fffbeb, #fff); }
        .frame-silver { border-color: #94a3b8; background: linear-gradient(to right, #f1f5f9, #fff); }
        .frame-gold { border-color: #eab308; background: linear-gradient(to right, #fefce8, #fff); box-shadow: 0 2px 4px rgba(234, 179, 8, 0.1); }
        .frame-diamond { border-color: #0ea5e9; background: linear-gradient(to right, #f0f9ff, #fff); box-shadow: 0 2px 4px rgba(14, 165, 233, 0.2); }
        .frame-master { border-color: #a855f7; background: linear-gradient(to right, #faf5ff, #fff); box-shadow: 0 0 10px rgba(168, 85, 247, 0.4); animation: pulse-purple 3s infinite; }
        @keyframes pulse-purple { 0% { box-shadow: 0 0 8px rgba(168, 85, 247, 0.3); } 50% { box-shadow: 0 0 15px rgba(168, 85, 247, 0.6); } 100% { box-shadow: 0 0 8px rgba(168, 85, 247, 0.3); } }

        .admin-only { display: none !important; } 
        .show-admin .admin-only { display: block !important; }
        .modal { transition: opacity 0.2s ease; }
        body.modal-active { overflow: hidden !important; }
        .selected-player { background-color: #4f46e5 !important; color: white !important; border-color: #4f46e5 !important; transform: scale(0.98); }
        .selected-player .sub-text { color: #a5b4fc !important; }
        .bet-active { background-color: #fef08a !important; border-color: #eab308 !important; color: #854d0e !important; }
        
        /* Animations */
        .animate-fire { animation: bounce-fire 1s infinite; }
        @keyframes bounce-fire { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-2px); } }
    </style>
</head>
<body class="p-4 max-w-2xl mx-auto pb-40">

    <div class="flex justify-between items-center mb-2 sticky top-0 bg-[#f1f5f9] z-20 py-2">
        <div>
            <div class="flex items-center gap-2">
                <h1 class="text-2xl font-bold text-slate-800">üè∏ Badminton <span class="text-indigo-600">Pro</span></h1>
            </div>
            <button onclick="openIdentityModal()" id="myIdentityBtn" class="text-xs mt-1 bg-white border border-slate-200 px-2 py-1 rounded-full flex items-center gap-1 hover:bg-slate-50 transition shadow-sm">
                <span class="w-2 h-2 rounded-full bg-slate-300" id="idStatus"></span><span id="myName">‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏±‡∏ß‡∏ï‡∏ô</span>
            </button>
        </div>
        <div class="flex gap-2">
            <div class="bg-yellow-100 border border-yellow-300 text-yellow-800 px-2 py-1 rounded-lg flex flex-col items-end leading-none justify-center shadow-sm">
                <span class="text-[10px] font-bold">B-Coin</span>
                <span class="text-sm font-bold" id="myWallet">0</span>
            </div>
            <button onclick="openCalculator()" class="text-xl p-2 bg-white text-emerald-600 shadow rounded-full hover:scale-110 transition border border-emerald-100">üí∞</button>
            <button onclick="toggleAdmin()" class="text-xl p-2 bg-white shadow rounded-full hover:scale-110 transition">üîí</button>
        </div>
    </div>

    <div class="bg-slate-800 text-white p-4 rounded-xl shadow-lg mb-6 admin-only hidden" id="adminPanel">
        <h3 class="font-bold text-sm mb-3 text-slate-300 flex justify-between">‚öôÔ∏è Admin Panel <button onclick="resetDay()" class="text-[10px] text-red-300 border border-red-300 px-2 rounded hover:bg-red-500 hover:text-white">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ß‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà</button></h3>
        <div class="flex gap-2 mb-3">
            <select id="courtCount" class="bg-slate-700 rounded px-2 py-2 text-sm flex-1"><option value="1">1 ‡∏Ñ‡∏≠‡∏£‡πå‡∏ó</option><option value="2" selected>2 ‡∏Ñ‡∏≠‡∏£‡πå‡∏ó</option><option value="3">3 ‡∏Ñ‡∏≠‡∏£‡πå‡∏ó</option></select>
        </div>
        <div class="grid grid-cols-2 gap-2">
            <button id="btnGenerate" class="bg-indigo-500 hover:bg-indigo-600 py-3 rounded-lg font-bold shadow-lg active:scale-95 transition text-sm">üöÄ ‡∏™‡∏∏‡πà‡∏°‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà</button>
            <button onclick="openManualModal()" class="bg-orange-500 hover:bg-orange-600 py-3 rounded-lg font-bold shadow-lg active:scale-95 transition text-sm">üëÜ ‡∏à‡∏¥‡πâ‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏≠‡∏á</button>
        </div>
    </div>

    <div id="courtsContainer" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6"></div>

    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4">
        <div class="flex gap-2 mb-4 admin-only hidden" id="addPlayerBox">
            <input type="text" id="inputName" placeholder="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å..." class="flex-1 bg-slate-50 border rounded px-3 py-2 text-sm">
            <button id="btnAdd" class="bg-indigo-600 text-white px-4 rounded font-bold hover:bg-indigo-700">+</button>
        </div>
        <div class="flex p-1 bg-slate-100 rounded-lg mb-4">
            <button onclick="setFilter('all')" id="tab-all" class="flex-1 py-1.5 text-xs font-bold rounded-md bg-white shadow text-indigo-600 transition">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
            <button onclick="setFilter('month')" id="tab-month" class="flex-1 py-1.5 text-xs font-bold rounded-md text-slate-500 hover:bg-white/50 transition">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</button>
            <button onclick="setFilter('day')" id="tab-day" class="flex-1 py-1.5 text-xs font-bold rounded-md text-slate-500 hover:bg-white/50 transition">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
        </div>
        <div class="flex justify-between items-end mb-2 px-2"><span class="text-sm font-bold text-slate-700" id="rankTitle">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (MMR)</span><span class="text-[10px] text-slate-400">‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ ‚úÖ</span></div>
        <div id="listContainer" class="space-y-3 pb-10"></div>
    </div>

    <div id="identityModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="absolute w-full h-full bg-gray-900 opacity-50" onclick="closeIdentityModal()"></div>
        <div class="bg-white w-11/12 md:max-w-md mx-auto rounded-xl shadow-2xl z-50 overflow-y-auto max-h-[90vh] p-6 relative">
            <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">üë§ ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡πÉ‡∏Ñ‡∏£?</h3><div onclick="closeIdentityModal()" class="cursor-pointer">‚úñ</div></div>
            <input type="text" id="searchIdentity" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠..." class="w-full border rounded-lg px-3 py-2 mb-2 bg-slate-50" onkeyup="filterIdentityList()">
            <div id="identityList" class="space-y-1 overflow-y-auto max-h-60"></div>
        </div>
    </div>

    <div id="calcModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="absolute w-full h-full bg-gray-900 opacity-60" onclick="closeCalculator()"></div>
        <div class="bg-white w-11/12 md:max-w-sm mx-auto rounded-xl shadow-2xl z-50 p-6 relative">
            <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold text-emerald-700">üí∞ ‡∏´‡∏≤‡∏£‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏£‡πå‡∏ó</h3><div onclick="closeCalculator()" class="cursor-pointer">‚úñ</div></div>
            <div class="mb-4"><label class="text-xs text-slate-500 font-bold">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏ö‡∏≤‡∏ó)</label><input type="number" id="calcTotal" class="w-full border-2 border-emerald-100 rounded-lg px-3 py-2 text-lg font-bold text-emerald-700 focus:outline-none focus:border-emerald-500" placeholder="0.00" oninput="calculateShare()"></div>
            <div class="mb-4 bg-emerald-50 rounded-lg p-3 border border-emerald-100">
                <div class="flex justify-between text-sm text-slate-600 mb-1"><span>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô (‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠):</span><span class="font-bold" id="calcCount">0</span></div>
                <div class="border-t border-emerald-200 my-2"></div>
                <div class="flex justify-between items-center"><span class="font-bold text-emerald-800">‡∏ï‡∏Å‡∏Ñ‡∏ô‡∏•‡∏∞:</span><span class="text-2xl font-bold text-emerald-600" id="calcResult">0</span></div>
            </div>
        </div>
    </div>
    
    <div id="manualModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="absolute w-full h-full bg-gray-900 opacity-80" onclick="closeManualModal()"></div>
        <div class="bg-white w-11/12 max-w-lg max-h-[90vh] rounded-xl shadow-2xl z-50 flex flex-col overflow-hidden relative">
            <div class="p-4 border-b flex justify-between items-center bg-slate-50 flex-none"><h3 class="text-lg font-bold text-slate-800">üëÜ ‡∏à‡∏¥‡πâ‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏≠‡∏á</h3><button onclick="closeManualModal()" class="text-slate-400 hover:text-red-500 text-2xl leading-none">&times;</button></div>
            <div class="p-3 bg-slate-100 flex gap-2 justify-center items-center shadow-inner flex-none">
                <div class="flex flex-col gap-2 w-1/2"><div class="bg-indigo-100 border-2 border-indigo-300 rounded p-1 text-center text-[10px] font-bold text-indigo-700 min-h-[35px] flex items-center justify-center" id="slot-0">A1...</div><div class="bg-indigo-100 border-2 border-indigo-300 rounded p-1 text-center text-[10px] font-bold text-indigo-700 min-h-[35px] flex items-center justify-center" id="slot-1">A2...</div></div>
                <div class="font-bold text-slate-400 text-xs">VS</div>
                <div class="flex flex-col gap-2 w-1/2"><div class="bg-orange-100 border-2 border-orange-300 rounded p-1 text-center text-[10px] font-bold text-orange-700 min-h-[35px] flex items-center justify-center" id="slot-2">B1...</div><div class="bg-orange-100 border-2 border-orange-300 rounded p-1 text-center text-[10px] font-bold text-orange-700 min-h-[35px] flex items-center justify-center" id="slot-3">B2...</div></div>
            </div>
            <div class="flex-1 overflow-y-auto p-4 bg-slate-50 min-h-0"><p class="text-xs text-slate-400 mb-2 text-center">‡πÅ‡∏ï‡∏∞‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</p><div id="manualList" class="space-y-2"></div></div>
            <div class="p-4 border-t bg-white flex-none"><button id="btnConfirmManual" onclick="confirmManualMatch()" disabled class="w-full bg-slate-300 text-white py-3 rounded-xl font-bold shadow transition">‡∏Ñ‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö (0/4)</button></div>
        </div>
    </div>

    <div id="statsModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="absolute w-full h-full bg-gray-900 opacity-60" onclick="closePlayerStats()"></div>
        <div class="bg-white w-11/12 md:max-w-sm mx-auto rounded-xl shadow-2xl z-50 p-5 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-20 bg-gradient-to-r from-indigo-500 to-purple-600 z-0"></div>
            <div class="relative z-10">
                <div class="flex justify-end"><button onclick="closePlayerStats()" class="text-white/80 hover:text-white text-xl font-bold">&times;</button></div>
                <div class="text-center mt-[-10px]">
                    <div class="w-16 h-16 bg-white rounded-full mx-auto flex items-center justify-center text-3xl shadow-lg border-2 border-indigo-100" id="statsIcon">üê£</div>
                    <h2 class="text-xl font-bold text-slate-800 mt-2" id="statsName">Name</h2>
                    <p class="text-xs text-slate-500" id="statsRank">Rookie</p>
                </div>
                <div class="grid grid-cols-2 gap-2 mt-4 text-center">
                    <div class="bg-yellow-50 p-2 rounded border border-yellow-200"><div class="text-xs text-yellow-600 font-bold">üí∞ ‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡∏ï‡∏±‡∏á‡∏Ñ‡πå</div><div class="font-bold text-yellow-700 text-lg" id="statsWallet">0</div></div>
                    <div class="bg-slate-50 p-2 rounded border"><div class="text-xs text-slate-400">‡∏ä‡∏ô‡∏∞/‡πÄ‡∏™‡∏°‡∏≠/‡πÅ‡∏û‡πâ</div><div class="font-bold text-slate-600"><span class="text-green-600" id="statsWin">0</span> / <span class="text-orange-500" id="statsDraw">0</span> / <span class="text-red-500" id="statsLoss">0</span></div></div>
                </div>
                <div class="mt-4 space-y-2">
                    <div class="bg-green-50 p-2 rounded-lg border border-green-100 flex items-center gap-2"><div class="text-xl">ü§ù</div><div class="flex-1"><div class="text-[9px] text-green-600 font-bold uppercase">‡∏Ñ‡∏π‡πà‡∏´‡∏π (Best Partner)</div><div class="font-bold text-slate-700 text-xs" id="bestPartner">-</div></div></div>
                    <div class="bg-red-50 p-2 rounded-lg border border-red-100 flex items-center gap-2"><div class="text-xl">üòà</div><div class="flex-1"><div class="text-[9px] text-red-600 font-bold uppercase">‡∏®‡∏±‡∏ï‡∏£‡∏π (Nemesis)</div><div class="font-bold text-slate-700 text-xs" id="worstEnemy">-</div></div></div>
                </div>
            </div>
        </div>
    </div>

    <div id="betModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="absolute w-full h-full bg-gray-900 opacity-60" onclick="closeBetModal()"></div>
        <div class="bg-white w-10/12 md:max-w-xs mx-auto rounded-xl shadow-2xl z-50 p-6 relative text-center">
            <h3 class="text-lg font-bold mb-2">üí∏ ‡∏•‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏û‡∏±‡∏ô</h3>
            <p class="text-sm text-slate-500 mb-4">‡∏ó‡∏≤‡∏¢‡∏ß‡πà‡∏≤‡∏ó‡∏µ‡∏° <span id="betTeamName" class="font-bold text-indigo-600">A</span> ‡∏à‡∏∞‡∏ä‡∏ô‡∏∞?</p>
            
            <div class="mb-4 bg-indigo-50 border border-indigo-100 rounded-lg p-2">
                <div class="text-[10px] text-indigo-400 uppercase font-bold tracking-wider">AI Prediction</div>
                <div class="text-sm font-bold text-indigo-700" id="aiPredictionText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì...</div>
            </div>

            <div class="flex justify-center gap-4 text-lg font-bold mb-4">
                <button onclick="adjustBet(-50)" class="w-8 h-8 rounded-full bg-slate-200 text-slate-600">-</button>
                <span class="text-slate-800 pt-1" id="betAmount">100</span>
                <button onclick="adjustBet(50)" class="w-8 h-8 rounded-full bg-slate-200 text-slate-600">+</button>
            </div>
            <button onclick="confirmBet()" class="w-full bg-yellow-400 hover:bg-yellow-500 text-yellow-900 font-bold py-2 rounded-lg shadow-sm">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô (‡∏à‡πà‡∏≤‡∏¢ <span id="betCost">100</span>)</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, setDoc, writeBatch, query, where, orderBy, limit } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        // üî¥ Config üî¥
        const firebaseConfig = {
            apiKey: "AIzaSyC6VSnH2H5zyFPbya0axgP38WiGczYU-oU",
            authDomain: "badminton-smasher-ai.firebaseapp.com",
            projectId: "badminton-smasher-ai",
            storageBucket: "badminton-smasher-ai.firebasestorage.app",
            messagingSenderId: "518167738562",
            appId: "1:518167738562:web:8ba84a7c1a350d16e3e35b",
            measurementId: "G-6X20YG49K9"
        };

        const SCORE_WIN = 20; const SCORE_DRAW = 5; const SCORE_LOSS = -10;
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const playersRef = collection(db, "players");
        const historyRef = collection(db, "match_history_v2");
        const systemRef = doc(db, "system", "courts_state");

        let playersList = [];
        let activeMatches = [];
        let historyList = [];
        let currentFilter = 'all';
        let myProfile = JSON.parse(localStorage.getItem('badminton_user')) || null;
        let isAdminMode = false;
        let manualSelected = [];
        
        let currentBetMatchId = null;
        let currentBetTeam = null;
        let currentBetAmount = 100;

        updateIdentityUI();

        onSnapshot(playersRef, (snapshot) => {
            playersList = [];
            snapshot.forEach(doc => playersList.push({ id: doc.id, ...doc.data() }));
            renderList(); updateIdentityUI();
            if(document.body.classList.contains('manual-mode-active')) renderManualList(); 
        });

        onSnapshot(systemRef, (docSnap) => {
            if (docSnap.exists()) activeMatches = docSnap.data().matches || [];
            else activeMatches = [];
            renderCourts();
        });

        const qHistory = query(historyRef, orderBy("timestamp", "desc"), limit(2000));
        onSnapshot(qHistory, (snapshot) => { historyList = []; snapshot.forEach(doc => historyList.push(doc.data())); renderList(); });

        // --- Betting & AI Logic ---
        function calculateWinProbability(teamA, teamB) {
            const scoreA = teamA.reduce((sum, p) => sum + (p.score || 1000), 0) / 2;
            const scoreB = teamB.reduce((sum, p) => sum + (p.score || 1000), 0) / 2;
            // Simple Elo-like probability: 1 / (1 + 10^((Rb-Ra)/400))
            const probA = 1 / (1 + Math.pow(10, (scoreB - scoreA) / 400));
            return Math.round(probA * 100);
        }

        window.openBetModal = (matchId, team) => {
            if(!myProfile) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏ó‡∏á!"); return; }
            const me = playersList.find(p => p.id === myProfile.id); if(!me) return;
            const match = activeMatches.find(m => m.id === matchId);
            const myBets = match.bets || {};
            if(myBets[myProfile.id]) { alert("‡∏Ñ‡∏∏‡∏ì‡∏•‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏û‡∏±‡∏ô‡∏Ñ‡∏π‡πà‡∏ô‡∏µ‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß!"); return; }

            currentBetMatchId = matchId; currentBetTeam = team; currentBetAmount = 100;
            document.getElementById('betTeamName').innerText = team;
            document.getElementById('betAmount').innerText = currentBetAmount;
            document.getElementById('betCost').innerText = currentBetAmount;

            // AI Calc
            const probA = calculateWinProbability(match.teamA, match.teamB);
            const probWin = team === 'A' ? probA : (100 - probA);
            document.getElementById('aiPredictionText').innerText = `‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏ó‡∏µ‡∏° ${team} ‡∏ä‡∏ô‡∏∞: ${probWin}%`;

            document.getElementById('betModal').classList.remove('opacity-0', 'pointer-events-none');
        }
        window.closeBetModal = () => { document.getElementById('betModal').classList.add('opacity-0', 'pointer-events-none'); }
        window.adjustBet = (val) => {
            currentBetAmount += val; if(currentBetAmount < 50) currentBetAmount = 50;
            const me = playersList.find(p => p.id === myProfile.id);
            if(me && currentBetAmount > (me.wallet || 0)) currentBetAmount = me.wallet || 0; 
            document.getElementById('betAmount').innerText = currentBetAmount;
            document.getElementById('betCost').innerText = currentBetAmount;
        }
        window.confirmBet = async () => {
            const me = playersList.find(p => p.id === myProfile.id);
            if(!me || (me.wallet || 0) < currentBetAmount) { alert("‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠!"); return; }
            const matches = [...activeMatches];
            const matchIndex = matches.findIndex(m => m.id === currentBetMatchId);
            if(matchIndex === -1) return;
            if(!matches[matchIndex].bets) matches[matchIndex].bets = {};
            matches[matchIndex].bets[myProfile.id] = { team: currentBetTeam, amount: currentBetAmount };
            const batch = writeBatch(db);
            batch.update(doc(db, "players", myProfile.id), { wallet: (me.wallet || 0) - currentBetAmount });
            batch.set(systemRef, { matches: matches });
            await batch.commit(); closeBetModal();
        }

        // --- Modals ---
        window.openIdentityModal = () => { document.getElementById('identityModal').classList.remove('opacity-0', 'pointer-events-none'); renderIdentityList(); }
        window.closeIdentityModal = () => { document.getElementById('identityModal').classList.add('opacity-0', 'pointer-events-none'); }
        window.openManualModal = () => { manualSelected = []; updateManualSlots(); renderManualList(); document.getElementById('manualModal').classList.remove('opacity-0', 'pointer-events-none'); document.body.classList.add('manual-mode-active'); }
        window.closeManualModal = () => { document.getElementById('manualModal').classList.add('opacity-0', 'pointer-events-none'); document.body.classList.remove('manual-mode-active'); }
        window.openCalculator = () => { document.getElementById('calcModal').classList.remove('opacity-0', 'pointer-events-none'); const count = playersList.filter(p => p.isPresent).length; document.getElementById('calcCount').innerText = count; calculateShare(); }
        window.closeCalculator = () => { document.getElementById('calcModal').classList.add('opacity-0', 'pointer-events-none'); }
        window.calculateShare = () => { const total = parseFloat(document.getElementById('calcTotal').value) || 0; const count = parseInt(document.getElementById('calcCount').innerText) || 1; const share = count > 0 ? Math.ceil(total / count) : 0; document.getElementById('calcResult').innerText = share + " ‡∏ö."; }

        window.openPlayerStats = (id) => {
            const p = playersList.find(x => x.id === id); if(!p) return;
            const rankInfo = getRankInfo(p.score);
            document.getElementById('statsIcon').innerText = rankInfo.icon;
            document.getElementById('statsName').innerText = p.name;
            document.getElementById('statsRank').innerText = `${rankInfo.name} | MMR ${p.score}`;
            document.getElementById('statsWallet').innerText = p.wallet || 0;
            document.getElementById('statsWin').innerText = p.wins || 0;
            document.getElementById('statsDraw').innerText = p.draws || 0;
            document.getElementById('statsLoss').innerText = p.losses || 0;
            // ... (Partner/Enemy Logic same as before) ...
            document.getElementById('statsModal').classList.remove('opacity-0', 'pointer-events-none');
        }
        window.closePlayerStats = () => { document.getElementById('statsModal').classList.add('opacity-0', 'pointer-events-none'); }

        // --- Manual ---
        window.toggleManualSelect = (id) => {
            const index = manualSelected.indexOf(id);
            if (index > -1) { manualSelected.splice(index, 1); } else { if (manualSelected.length < 4) { manualSelected.push(id); } else { return; } }
            updateManualSlots(); renderManualList();
        }
        function updateManualSlots() {
            for(let i=0; i<4; i++) {
                const el = document.getElementById(`slot-${i}`);
                if (manualSelected[i]) {
                    const p = playersList.find(x => x.id === manualSelected[i]);
                    el.innerText = p ? p.name : '...';
                    el.className = i < 2 ? "bg-indigo-600 rounded p-1 text-[10px] font-bold text-white min-h-[35px] flex items-center justify-center shadow" : "bg-orange-500 rounded p-1 text-[10px] font-bold text-white min-h-[35px] flex items-center justify-center shadow";
                } else {
                    el.innerText = i < 2 ? `A${i+1}...` : `B${i-1}...`;
                    el.className = "bg-slate-100 border border-dashed rounded p-1 text-[10px] text-slate-400 min-h-[35px] flex items-center justify-center";
                }
            }
            const btn = document.getElementById('btnConfirmManual');
            if (manualSelected.length === 4) { btn.disabled = false; btn.innerText = "‚úÖ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏Ç‡πà‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ"; btn.className = "w-full bg-green-500 hover:bg-green-600 text-white py-3 rounded-xl font-bold shadow-lg transition"; } 
            else { btn.disabled = true; btn.innerText = `‡∏Ñ‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö (${manualSelected.length}/4)`; btn.className = "w-full bg-slate-300 text-white py-3 rounded-xl font-bold shadow transition cursor-not-allowed"; }
        }
        function renderManualList() {
            const list = document.getElementById('manualList'); list.innerHTML = '';
            const playingIds = new Set(); activeMatches.forEach(m => { m.teamA.forEach(p => playingIds.add(p.id)); m.teamB.forEach(p => playingIds.add(p.id)); });
            let eligible = playersList.filter(p => p.isPresent).sort((a,b) => b.score - a.score);
            eligible.forEach(p => {
                const isSelected = manualSelected.includes(p.id); const isPlaying = playingIds.has(p.id); const rankInfo = getRankInfo(p.score);
                let cardClass = `flex justify-between items-center p-3 rounded-lg border-2 mb-2 relative transition cursor-pointer select-none `;
                if (isSelected) { cardClass += "selected-player border-indigo-500 shadow-md"; } else if (isPlaying) { cardClass += "bg-slate-100 opacity-40 cursor-not-allowed grayscale"; } else { cardClass += `bg-white ${rankInfo.frame}`; }
                const onclick = isPlaying ? '' : `onclick="toggleManualSelect('${p.id}')"`;
                list.innerHTML += `<div ${onclick} class="${cardClass}"><div class="flex items-center gap-3"><div class="font-bold text-lg">${rankInfo.icon}</div><div><div class="font-bold text-sm ${isSelected ? 'text-white' : 'text-slate-700'}">${p.name}</div></div></div>${isSelected ? '<div class="text-white text-xl">‚úì</div>' : ''}</div>`;
            });
        }
        window.confirmManualMatch = async () => {
            if (manualSelected.length !== 4) return;
            const pA1 = playersList.find(x => x.id === manualSelected[0]); const pA2 = playersList.find(x => x.id === manualSelected[1]);
            const pB1 = playersList.find(x => x.id === manualSelected[2]); const pB2 = playersList.find(x => x.id === manualSelected[3]);
            const newMatches = [...activeMatches];
            newMatches.push({ id: Date.now(), courtNo: findNextCourtNo(newMatches), teamA: [pA1, pA2], teamB: [pB1, pB2], startTime: Date.now(), bets: {} });
            await setDoc(systemRef, { matches: newMatches }); closeManualModal();
        }

        // --- Core ---
        window.renderIdentityList = () => {
            const list = document.getElementById('identityList'); const search = document.getElementById('searchIdentity').value.toLowerCase(); list.innerHTML = '';
            const filtered = playersList.filter(p => p.name.toLowerCase().includes(search));
            if(myProfile) list.innerHTML += `<button onclick="logoutIdentity()" class="w-full text-left px-4 py-2 text-red-500 font-bold border border-red-200 rounded hover:bg-red-50 mb-2">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö (${myProfile.name})</button>`;
            filtered.sort((a,b) => a.name.localeCompare(b.name)).forEach(p => {
                const isActive = myProfile && myProfile.id === p.id;
                list.innerHTML += `<button onclick="selectIdentity('${p.id}', '${p.name}')" class="w-full text-left px-4 py-3 rounded border ${isActive ? 'bg-indigo-50 border-indigo-500 text-indigo-700' : 'bg-white border-slate-100 hover:bg-slate-50'}">${p.name} ${isActive ? '‚úÖ' : ''}</button>`;
            });
        }
        window.filterIdentityList = renderIdentityList;
        window.selectIdentity = (id, name) => { myProfile = { id, name }; localStorage.setItem('badminton_user', JSON.stringify(myProfile)); updateIdentityUI(); closeIdentityModal(); renderCourts(); }
        window.logoutIdentity = () => { myProfile = null; localStorage.removeItem('badminton_user'); updateIdentityUI(); closeIdentityModal(); renderCourts(); }
        function updateIdentityUI() {
            const nameEl = document.getElementById('myName'); const statusEl = document.getElementById('idStatus'); const walletEl = document.getElementById('myWallet');
            if (myProfile) { 
                nameEl.innerText = myProfile.name; nameEl.className = "font-bold text-indigo-700"; statusEl.className = "w-2 h-2 rounded-full bg-green-500"; 
                const me = playersList.find(p => p.id === myProfile.id); walletEl.innerText = me ? (me.wallet || 0) : 0;
            } else { nameEl.innerText = "‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏±‡∏ß‡∏ï‡∏ô"; nameEl.className = "text-slate-500"; statusEl.className = "w-2 h-2 rounded-full bg-slate-300"; walletEl.innerText = "-"; }
        }

        function renderCourts() {
            const container = document.getElementById('courtsContainer'); container.innerHTML = '';
            activeMatches.sort((a, b) => a.courtNo - b.courtNo);
            if (activeMatches.length === 0) { container.innerHTML = `<div class="text-center text-slate-400 py-6 col-span-full border-2 border-dashed border-slate-200 rounded-xl">‡∏™‡∏ô‡∏≤‡∏°‡∏ß‡πà‡∏≤‡∏á...</div>`; return; }

            activeMatches.forEach(m => {
                let amIPlaying = false;
                if (myProfile) { const allPlayers = [...m.teamA, ...m.teamB]; amIPlaying = allPlayers.some(p => p.id === myProfile.id); }
                const showControls = isAdminMode || amIPlaying; const controlClass = showControls ? '' : 'hidden';
                const showBet = myProfile && !amIPlaying;
                const bets = m.bets || {}; const myBet = myProfile ? bets[myProfile.id] : null;
                const totalBetA = Object.values(bets).filter(b => b.team === 'A').reduce((sum, b) => sum + b.amount, 0);
                const totalBetB = Object.values(bets).filter(b => b.team === 'B').reduce((sum, b) => sum + b.amount, 0);
                
                // Prediction Display
                const probA = calculateWinProbability(m.teamA, m.teamB);

                container.innerHTML += `
                    <div class="rounded-xl p-1 shadow-lg text-white bg-gradient-to-br from-slate-700 to-slate-800 court-card relative ${amIPlaying ? 'ring-4 ring-yellow-400' : ''}">
                        <div class="absolute top-2 left-2 bg-white/20 px-2 rounded text-xs font-bold">Court ${m.courtNo}</div>
                        <button onclick="cancelMatch(${m.id})" class="absolute top-2 right-2 text-white/50 hover:text-white text-xs admin-only">‚úñ</button>
                        <div class="bg-white rounded-lg p-3 text-slate-800 mt-8">
                            
                            <div class="mb-3 flex items-center gap-1 text-[9px] font-bold uppercase tracking-wider text-slate-400">
                                <div>AI WIN PROBABILITY</div>
                                <div class="flex-1 h-1.5 bg-orange-100 rounded-full overflow-hidden flex">
                                    <div class="bg-indigo-500 h-full" style="width: ${probA}%"></div>
                                </div>
                            </div>

                            <div class="flex justify-between items-center mb-1 p-1 rounded hover:bg-indigo-50 border-l-4 border-indigo-500 relative">
                                <div>
                                    <div class="text-sm font-bold leading-tight pl-2">${m.teamA[0].name}<br>${m.teamA[1].name}</div>
                                    <div class="text-[10px] text-indigo-400 pl-2">Win ${probA}% | Bet ${totalBetA}</div>
                                </div>
                                <div class="flex flex-col gap-1 items-end">
                                    <button onclick="finishMatch(${m.id}, 'A_WIN')" class="${controlClass} bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full text-xs font-bold">‡∏ä‡∏ô‡∏∞</button>
                                    ${showBet ? `<button onclick="openBetModal(${m.id}, 'A')" class="text-[10px] px-2 py-0.5 border rounded ${myBet && myBet.team === 'A' ? 'bet-active' : 'border-slate-300 text-slate-400'}">‡πÅ‡∏ó‡∏á A</button>` : ''}
                                </div>
                            </div>
                            <div class="flex justify-center my-1"><button onclick="finishMatch(${m.id}, 'DRAW')" class="${controlClass} bg-slate-100 text-slate-500 px-4 py-0.5 rounded-full text-[10px] font-bold">‡πÄ‡∏™‡∏°‡∏≠</button></div>
                            <div class="flex justify-between items-center mt-1 p-1 rounded hover:bg-orange-50 border-l-4 border-orange-500 relative">
                                <div>
                                    <div class="text-sm font-bold leading-tight pl-2">${m.teamB[0].name}<br>${m.teamB[1].name}</div>
                                    <div class="text-[10px] text-orange-400 pl-2">Win ${100-probA}% | Bet ${totalBetB}</div>
                                </div>
                                <div class="flex flex-col gap-1 items-end">
                                    <button onclick="finishMatch(${m.id}, 'B_WIN')" class="${controlClass} bg-orange-100 text-orange-700 px-3 py-1 rounded-full text-xs font-bold">‡∏ä‡∏ô‡∏∞</button>
                                    ${showBet ? `<button onclick="openBetModal(${m.id}, 'B')" class="text-[10px] px-2 py-0.5 border rounded ${myBet && myBet.team === 'B' ? 'bet-active' : 'border-slate-300 text-slate-400'}">‡πÅ‡∏ó‡∏á B</button>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        function calculateStats(player, filter) {
            if (filter === 'all') return { value: player.score, label: 'MMR', displayClass: 'text-slate-800' };
            const now = new Date(); let cutoff = new Date();
            if (filter === 'day') cutoff.setHours(0,0,0,0);
            if (filter === 'month') { cutoff.setDate(1); cutoff.setHours(0,0,0,0); }
            const timestampCutoff = cutoff.getTime();
            const relevantMatches = historyList.filter(m => m.timestamp >= timestampCutoff);
            let netChange = 0; let wins = 0, draws = 0, losses = 0;
            relevantMatches.forEach(m => {
                let change = 0;
                if (m.teamA_ids.includes(player.id)) change = m.change_A;
                else if (m.teamB_ids.includes(player.id)) change = m.change_B;
                if (change !== 0) { netChange += change; if (change > 0 && change >= SCORE_WIN) wins++; else if (change < 0) losses++; else draws++; }
            });
            let label = netChange > 0 ? `+${netChange}` : `${netChange}`;
            let displayClass = netChange > 0 ? 'text-green-600' : (netChange < 0 ? 'text-red-500' : 'text-slate-400');
            return { value: netChange, label, displayClass, wins, draws, losses };
        }
        function getRankInfo(score) {
            if (score >= 2000) return { frame: 'frame-master', icon: 'üî•', name: 'Grand Master' };
            if (score >= 1800) return { frame: 'frame-diamond', icon: 'üíé', name: 'Diamond' };
            if (score >= 1500) return { frame: 'frame-gold', icon: 'ü•á', name: 'Gold' };
            if (score >= 1300) return { frame: 'frame-silver', icon: 'ü•à', name: 'Silver' };
            if (score >= 1100) return { frame: 'frame-bronze', icon: 'ü•â', name: 'Bronze' };
            return { frame: 'frame-rookie', icon: 'üê£', name: 'Rookie' };
        }

        document.getElementById('btnAdd').onclick = async () => {
            const name = document.getElementById('inputName').value.trim(); if (!name) return;
            if(playersList.some(p => p.name == name)) { alert('‡∏ä‡∏∑‡πà‡∏≠‡∏ã‡πâ‡∏≥!'); return; }
            await addDoc(playersRef, { name: name, score: 1000, wallet: 1000, streak: 0, matches: 0, wins: 0, draws: 0, losses: 0, isPresent: true, createdAt: Date.now() });
            document.getElementById('inputName').value = '';
        };
        window.togglePresence = async (id, currentStatus) => { await updateDoc(doc(db, "players", id), { isPresent: !currentStatus }); }
        window.resetDay = async () => { if(!confirm("‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠?")) return; const batch = writeBatch(db); playersList.forEach(p => batch.update(doc(db, "players", p.id), { isPresent: false })); await batch.commit(); }
        window.deletePlayer = async (id) => { if(confirm("‡∏•‡∏ö‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡∏ñ‡∏≤‡∏ß‡∏£?")) await deleteDoc(doc(db, "players", id)); }

        document.getElementById('btnGenerate').onclick = async () => {
            const maxCourts = parseInt(document.getElementById('courtCount').value); const slots = maxCourts - activeMatches.length;
            if (slots <= 0) return alert("‡∏Ñ‡∏≠‡∏£‡πå‡∏ó‡πÄ‡∏ï‡πá‡∏°!");
            const playingIds = new Set(); activeMatches.forEach(m => { m.teamA.forEach(p => playingIds.add(p.id)); m.teamB.forEach(p => playingIds.add(p.id)); });
            let pool = playersList.filter(p => p.isPresent && !playingIds.has(p.id));
            if (pool.length < 4) return alert("‡∏Ñ‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠!");
            pool.sort((a, b) => a.matches - b.matches || 0.5 - Math.random());
            const newMatches = [...activeMatches];
            for (let i = 0; i < slots; i++) {
                if (pool.length < 4) break; let sel = pool.slice(0, 4); pool = pool.slice(4);
                sel.sort((a, b) => b.score - a.score);
                newMatches.push({ id: Date.now() + i, courtNo: findNextCourtNo(newMatches), teamA: [sel[0], sel[3]], teamB: [sel[1], sel[2]], startTime: Date.now(), bets: {} });
            }
            await setDoc(systemRef, { matches: newMatches });
        };
        function findNextCourtNo(list) { const used = new Set(list.map(m => m.courtNo)); let i = 1; while(used.has(i)) i++; return i; }

        window.finishMatch = async (matchId, result) => {
            const msg = result === 'DRAW' ? '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ú‡∏• ‡πÄ‡∏™‡∏°‡∏≠?' : `‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ó‡∏µ‡∏° ${result === 'A_WIN' ? 'A' : 'B'} ‡∏ä‡∏ô‡∏∞?`;
            if (!confirm(msg)) return;
            const match = activeMatches.find(m => m.id === matchId); if (!match) return;
            const batch = writeBatch(db);
            
            // Score & Streak Logic
            let changeA = 0, changeB = 0;
            if (result === 'A_WIN') { changeA = SCORE_WIN; changeB = SCORE_LOSS; } else if (result === 'B_WIN') { changeA = SCORE_LOSS; changeB = SCORE_WIN; } else { changeA = SCORE_DRAW; changeB = SCORE_DRAW; }
            
            [...match.teamA, ...match.teamB].forEach(p => {
                const isA = match.teamA.some(x => x.id === p.id); const change = isA ? changeA : changeB;
                const ref = doc(db, "players", p.id); const curr = playersList.find(x => x.id === p.id);
                if(curr) {
                    // Update Streak
                    let newStreak = curr.streak || 0;
                    if (change > 0 && change >= SCORE_WIN) { newStreak = newStreak > 0 ? newStreak + 1 : 1; } // Win
                    else if (change < 0) { newStreak = newStreak < 0 ? newStreak - 1 : -1; } // Loss
                    else { newStreak = 0; } // Draw/Other resets

                    const newScore = Math.max(0, curr.score + change);
                    const wins = curr.wins + ((isA && result==='A_WIN') || (!isA && result==='B_WIN') ? 1 : 0);
                    const draws = (curr.draws || 0) + (result === 'DRAW' ? 1 : 0);
                    const losses = (curr.losses || 0) + (change < 0 ? 1 : 0);
                    batch.update(ref, { score: newScore, streak: newStreak, matches: curr.matches + 1, wins, draws, losses });
                }
            });

            // Betting Payout
            const bets = match.bets || {};
            let winningTeam = result === 'A_WIN' ? 'A' : (result === 'B_WIN' ? 'B' : null);
            if (winningTeam) {
                Object.keys(bets).forEach(playerId => {
                    const bet = bets[playerId];
                    if (bet.team === winningTeam) {
                        const player = playersList.find(p => p.id === playerId);
                        if (player) batch.update(doc(db, "players", playerId), { wallet: (player.wallet || 0) + (bet.amount * 2) });
                    }
                });
            } else if (result === 'DRAW') {
                 Object.keys(bets).forEach(playerId => {
                    const bet = bets[playerId];
                    const player = playersList.find(p => p.id === playerId);
                    if (player) batch.update(doc(db, "players", playerId), { wallet: (player.wallet || 0) + bet.amount });
                });
            }

            const historyDoc = doc(historyRef);
            batch.set(historyDoc, { timestamp: Date.now(), result_type: result, teamA_ids: match.teamA.map(p => p.id), teamB_ids: match.teamB.map(p => p.id), change_A: changeA, change_B: changeB });
            const remaining = activeMatches.filter(m => m.id !== matchId);
            batch.set(systemRef, { matches: remaining });
            await batch.commit();
        };
        window.cancelMatch = async (matchId) => { 
            const match = activeMatches.find(m => m.id === matchId);
            if (match && match.bets) {
                const batch = writeBatch(db);
                Object.keys(match.bets).forEach(playerId => {
                    const bet = match.bets[playerId];
                    const player = playersList.find(p => p.id === playerId);
                    if (player) batch.update(doc(db, "players", playerId), { wallet: (player.wallet || 0) + bet.amount });
                });
                const remaining = activeMatches.filter(m => m.id !== matchId);
                batch.set(systemRef, { matches: remaining });
                await batch.commit();
            } else {
                if(!confirm("‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å?")) return;
                const remaining = activeMatches.filter(m => m.id !== matchId); await setDoc(systemRef, { matches: remaining }); 
            }
        }
        
        window.setFilter = (filter) => {
            currentFilter = filter;
            ['all','month','day'].forEach(f => {
                const btn = document.getElementById(`tab-${f}`);
                if(f === filter) btn.className = "flex-1 py-1.5 text-xs font-bold rounded-md bg-white shadow text-indigo-600 transition";
                else btn.className = "flex-1 py-1.5 text-xs font-bold rounded-md text-slate-500 hover:bg-white/50 transition";
            });
            const titles = { all: "‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (MMR)", month: "‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ (‡πÅ‡∏ï‡πâ‡∏°)", day: "‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (‡πÅ‡∏ï‡πâ‡∏°)" };
            document.getElementById('rankTitle').innerText = titles[filter];
            renderList();
        }

        function renderList() {
            const list = document.getElementById('listContainer');
            list.innerHTML = '';
            let displayList = playersList.map(p => { const stats = calculateStats(p, currentFilter); return { ...p, ...stats }; });
            displayList.sort((a, b) => b.value - a.value);
            const playingIds = new Set();
            activeMatches.forEach(m => { m.teamA.forEach(p => playingIds.add(p.id)); m.teamB.forEach(p => playingIds.add(p.id)); });

            displayList.forEach((p, idx) => {
                if (currentFilter !== 'all' && p.value === 0) return;
                const rankInfo = getRankInfo(p.score);
                const isPlaying = playingIds.has(p.id);
                
                // Streak Logic UI
                let streakIcon = '';
                if(p.streak >= 3) streakIcon = `<span class="ml-1 text-lg animate-fire" title="‡∏ä‡∏ô‡∏∞‡∏ï‡∏¥‡∏î‡∏Å‡∏±‡∏ô ${p.streak} ‡∏ï‡∏≤">üî•</span>`;
                else if(p.streak <= -3) streakIcon = `<span class="ml-1 text-lg" title="‡πÅ‡∏û‡πâ‡∏ï‡∏¥‡∏î‡∏Å‡∏±‡∏ô ${Math.abs(p.streak)} ‡∏ï‡∏≤">‚ùÑÔ∏è</span>`;

                list.innerHTML += `
                    <div onclick="openPlayerStats('${p.id}')" class="flex justify-between items-center p-3 rounded-lg mb-2 card-base ${rankInfo.frame} ${!p.isPresent ? 'opacity-50 grayscale border-slate-200 bg-white' : ''} relative cursor-pointer hover:scale-[1.01] transition-transform">
                        <div class="flex items-center gap-3">
                            <div class="admin-only" onclick="event.stopPropagation()"><input type="checkbox" ${p.isPresent ? 'checked' : ''} onchange="togglePresence('${p.id}', ${p.isPresent})" class="w-4 h-4 rounded text-indigo-600 cursor-pointer"></div>
                            <div class="font-bold text-slate-400 w-5 text-center text-sm">${idx+1}</div>
                            <div>
                                <div class="font-bold text-slate-700 flex items-center gap-2 text-base">
                                    ${rankInfo.icon} ${p.name} ${streakIcon}
                                    ${isPlaying ? '<span class="text-[8px] bg-indigo-500 text-white px-1.5 rounded animate-pulse">PLAYING</span>' : ''}
                                </div>
                                <div class="text-[10px] text-slate-400 font-bold tracking-wide flex gap-2">
                                    <span class="text-yellow-600">üí∞${p.wallet || 0}</span> | MMR ${p.score}
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="text-right">
                                <div class="font-bold text-lg ${p.displayClass}">${p.label}</div>
                                <div class="text-[10px] text-slate-400">‡πÅ‡∏Ç‡πà‡∏á ${p.matches}</div>
                            </div>
                            <button onclick="event.stopPropagation(); deletePlayer('${p.id}')" class="admin-only text-slate-300 hover:text-red-500 text-xl px-1">√ó</button>
                        </div>
                    </div>
                `;
            });
            if(list.innerHTML === '') list.innerHTML = `<div class="text-center text-sm text-slate-400 py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>`;
        }

        window.toggleAdmin = function() {
            if(isAdminMode) { isAdminMode = false; document.body.classList.remove('show-admin'); document.getElementById('adminPanel').classList.add('hidden'); document.getElementById('addPlayerBox').classList.add('hidden'); renderCourts(); }
            else { const pass = prompt("Admin Password:"); if (pass === "1234") { isAdminMode = true; document.body.classList.add('show-admin'); document.getElementById('adminPanel').classList.remove('hidden'); document.getElementById('addPlayerBox').classList.remove('hidden'); renderCourts(); } }
        }
    </script>
</body>
</html>
