<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Badminton Pro League üèÜ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Kanit', sans-serif; background-color: #f1f5f9; }
        
        /* Rank Frames */
        .card-base { border: 2px solid; transition: all 0.2s; }
        .frame-rookie { border-color: #cbd5e1; background: white; }
        .frame-bronze { border-color: #fbbf24; background: linear-gradient(to right, #fffbeb, #fff); }
        .frame-silver { border-color: #94a3b8; background: linear-gradient(to right, #f1f5f9, #fff); }
        .frame-gold { border-color: #eab308; background: linear-gradient(to right, #fefce8, #fff); box-shadow: 0 2px 4px rgba(234, 179, 8, 0.1); }
        .frame-diamond { border-color: #0ea5e9; background: linear-gradient(to right, #f0f9ff, #fff); box-shadow: 0 2px 4px rgba(14, 165, 233, 0.2); }
        .frame-master { border-color: #a855f7; background: linear-gradient(to right, #faf5ff, #fff); box-shadow: 0 0 10px rgba(168, 85, 247, 0.4); animation: pulse-purple 3s infinite; }
        @keyframes pulse-purple { 0% { box-shadow: 0 0 8px rgba(168, 85, 247, 0.3); } 50% { box-shadow: 0 0 15px rgba(168, 85, 247, 0.6); } 100% { box-shadow: 0 0 8px rgba(168, 85, 247, 0.3); } }

        .admin-only { display: none !important; } 
        .show-admin .admin-only { display: block !important; }
        
        /* Modal & Animations */
        .modal { transition: opacity 0.2s ease; }
        body.modal-active { overflow: hidden !important; }
        .selected-player { background-color: #4f46e5 !important; color: white !important; border-color: #4f46e5 !important; transform: scale(0.98); }
        .selected-player .sub-text { color: #a5b4fc !important; }
    </style>
</head>
<body class="p-4 max-w-2xl mx-auto pb-40">

    <div class="flex justify-between items-center mb-2 sticky top-0 bg-[#f1f5f9] z-20 py-2">
        <div>
            <div class="flex items-center gap-2">
                <h1 class="text-2xl font-bold text-slate-800">üè∏ Badminton <span class="text-indigo-600">Pro</span></h1>
                <button onclick="openRankInfo()" class="text-[10px] bg-white text-indigo-600 px-3 py-1 rounded-full border border-indigo-100 shadow-sm font-bold flex items-center gap-1 hover:bg-indigo-50">üèÜ ‡∏î‡∏π‡πÄ‡∏Å‡∏ì‡∏ë‡πå</button>
            </div>
            <button onclick="openIdentityModal()" id="myIdentityBtn" class="text-xs mt-1 bg-white border border-slate-200 px-2 py-1 rounded-full flex items-center gap-1 hover:bg-slate-50 transition shadow-sm">
                <span class="w-2 h-2 rounded-full bg-slate-300" id="idStatus"></span><span id="myName">‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏±‡∏ß‡∏ï‡∏ô</span>
            </button>
        </div>
        <div class="flex gap-2">
            <div id="statusIndicator" class="hidden text-[10px] px-2 py-1 rounded bg-gray-200 text-gray-500">...</div>
            <button onclick="toggleAdmin()" class="text-xl p-2 bg-white shadow rounded-full hover:scale-110 transition">üîí</button>
        </div>
    </div>

    <div class="bg-slate-800 text-white p-4 rounded-xl shadow-lg mb-6 admin-only hidden" id="adminPanel">
        <h3 class="font-bold text-sm mb-3 text-slate-300 flex justify-between">‚öôÔ∏è Admin Panel <button onclick="resetDay()" class="text-[10px] text-red-300 border border-red-300 px-2 rounded hover:bg-red-500 hover:text-white">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ß‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà</button></h3>
        <div class="flex gap-2 mb-3">
            <select id="courtCount" class="bg-slate-700 rounded px-2 py-2 text-sm flex-1"><option value="1">1 ‡∏Ñ‡∏≠‡∏£‡πå‡∏ó</option><option value="2" selected>2 ‡∏Ñ‡∏≠‡∏£‡πå‡∏ó</option><option value="3">3 ‡∏Ñ‡∏≠‡∏£‡πå‡∏ó</option></select>
        </div>
        <div class="grid grid-cols-2 gap-2">
            <button id="btnGenerate" class="bg-indigo-500 hover:bg-indigo-600 py-3 rounded-lg font-bold shadow-lg active:scale-95 transition text-sm">üöÄ ‡∏™‡∏∏‡πà‡∏°‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà</button>
            <button onclick="openManualModal()" class="bg-orange-500 hover:bg-orange-600 py-3 rounded-lg font-bold shadow-lg active:scale-95 transition text-sm">üëÜ ‡∏à‡∏¥‡πâ‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏≠‡∏á</button>
        </div>
    </div>

    <div id="courtsContainer" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6"></div>

    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4">
        <div class="flex gap-2 mb-4 admin-only hidden" id="addPlayerBox">
            <input type="text" id="inputName" placeholder="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å..." class="flex-1 bg-slate-50 border rounded px-3 py-2 text-sm">
            <button id="btnAdd" class="bg-indigo-600 text-white px-4 rounded font-bold hover:bg-indigo-700">+</button>
        </div>
        <div class="flex p-1 bg-slate-100 rounded-lg mb-4">
            <button onclick="setFilter('all')" id="tab-all" class="flex-1 py-1.5 text-xs font-bold rounded-md bg-white shadow text-indigo-600 transition">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
            <button onclick="setFilter('month')" id="tab-month" class="flex-1 py-1.5 text-xs font-bold rounded-md text-slate-500 hover:bg-white/50 transition">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</button>
            <button onclick="setFilter('day')" id="tab-day" class="flex-1 py-1.5 text-xs font-bold rounded-md text-slate-500 hover:bg-white/50 transition">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
        </div>
        <div class="flex justify-between items-end mb-2 px-2"><span class="text-sm font-bold text-slate-700" id="rankTitle">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (MMR)</span><span class="text-[10px] text-slate-400">‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ ‚úÖ</span></div>
        <div id="listContainer" class="space-y-3 pb-10"></div>
    </div>

    <div id="identityModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="absolute w-full h-full bg-gray-900 opacity-50" onclick="closeIdentityModal()"></div>
        <div class="bg-white w-11/12 md:max-w-md mx-auto rounded-xl shadow-2xl z-50 overflow-y-auto max-h-[90vh] p-6 relative">
            <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">üë§ ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡πÉ‡∏Ñ‡∏£?</h3><div onclick="closeIdentityModal()" class="cursor-pointer">‚úñ</div></div>
            <input type="text" id="searchIdentity" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠..." class="w-full border rounded-lg px-3 py-2 mb-2 bg-slate-50" onkeyup="filterIdentityList()">
            <div id="identityList" class="space-y-1 overflow-y-auto max-h-60"></div>
        </div>
    </div>

    <div id="rankModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="absolute w-full h-full bg-gray-900 opacity-60" onclick="closeRankModal()"></div>
        <div class="bg-white w-11/12 md:max-w-sm mx-auto rounded-xl shadow-2xl z-50 p-6 relative">
            <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">üèÜ ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÅ‡∏£‡∏á‡∏Ñ‡πå</h3><div onclick="closeRankModal()" class="cursor-pointer">‚úñ</div></div>
            <div class="space-y-3 text-sm">
                <div class="flex justify-between p-2 rounded border-2 border-purple-500 bg-purple-50"><span>üî• GRAND MASTER</span><span class="font-bold">2000+</span></div>
                <div class="flex justify-between p-2 rounded border-2 border-sky-500 bg-sky-50"><span>üíé DIAMOND</span><span class="font-bold">1800+</span></div>
                <div class="flex justify-between p-2 rounded border-2 border-yellow-400 bg-yellow-50"><span>ü•á GOLD</span><span class="font-bold">1500+</span></div>
                <div class="flex justify-between p-2 rounded border-2 border-slate-400 bg-slate-50"><span>ü•à SILVER</span><span class="font-bold">1300+</span></div>
                <div class="flex justify-between p-2 rounded border-2 border-orange-400 bg-orange-50"><span>ü•â BRONZE</span><span class="font-bold">1100+</span></div>
                <div class="flex justify-between p-2 rounded border-2 border-slate-200"><span>üê£ ROOKIE</span><span class="font-bold">0-1099</span></div>
            </div>
        </div>
    </div>

    <div id="manualModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="absolute w-full h-full bg-gray-900 opacity-80" onclick="closeManualModal()"></div>
        <div class="bg-white w-full h-full md:h-auto md:w-11/12 md:max-w-lg md:rounded-xl shadow-2xl z-50 flex flex-col relative">
            
            <div class="p-4 border-b flex justify-between items-center bg-slate-50 md:rounded-t-xl">
                <h3 class="text-lg font-bold text-slate-800">üëÜ ‡∏à‡∏¥‡πâ‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏≠‡∏á (4 ‡∏Ñ‡∏ô)</h3>
                <button onclick="closeManualModal()" class="text-slate-400 hover:text-red-500 text-2xl leading-none">&times;</button>
            </div>

            <div class="p-4 bg-slate-100 flex gap-2 justify-center items-center shadow-inner">
                <div class="flex flex-col gap-2 w-1/2">
                    <div class="bg-indigo-100 border-2 border-indigo-300 rounded p-2 text-center text-xs font-bold text-indigo-700 min-h-[40px] flex items-center justify-center" id="slot-0">‡∏£‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å A1...</div>
                    <div class="bg-indigo-100 border-2 border-indigo-300 rounded p-2 text-center text-xs font-bold text-indigo-700 min-h-[40px] flex items-center justify-center" id="slot-1">‡∏£‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å A2...</div>
                </div>
                <div class="font-bold text-slate-400 text-xs">VS</div>
                <div class="flex flex-col gap-2 w-1/2">
                    <div class="bg-orange-100 border-2 border-orange-300 rounded p-2 text-center text-xs font-bold text-orange-700 min-h-[40px] flex items-center justify-center" id="slot-2">‡∏£‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å B1...</div>
                    <div class="bg-orange-100 border-2 border-orange-300 rounded p-2 text-center text-xs font-bold text-orange-700 min-h-[40px] flex items-center justify-center" id="slot-3">‡∏£‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å B2...</div>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto p-4 bg-slate-50">
                <p class="text-xs text-slate-400 mb-2 text-center">‡πÅ‡∏ï‡∏∞‡∏ó‡∏µ‡πà‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤/‡∏≠‡∏≠‡∏Å ‡∏à‡∏≤‡∏Å‡∏™‡∏ô‡∏≤‡∏°</p>
                <div id="manualList" class="space-y-2 pb-20"></div>
            </div>

            <div class="p-4 border-t bg-white absolute bottom-0 w-full md:relative md:rounded-b-xl">
                <button id="btnConfirmManual" onclick="confirmManualMatch()" disabled class="w-full bg-slate-300 text-white py-3 rounded-xl font-bold shadow transition">
                    ‡∏Ñ‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö (0/4)
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, setDoc, writeBatch, query, where, orderBy, limit } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        // üî¥ Config üî¥
        const firebaseConfig = {
            apiKey: "AIzaSyC6VSnH2H5zyFPbya0axgP38WiGczYU-oU",
            authDomain: "badminton-smasher-ai.firebaseapp.com",
            projectId: "badminton-smasher-ai",
            storageBucket: "badminton-smasher-ai.firebasestorage.app",
            messagingSenderId: "518167738562",
            appId: "1:518167738562:web:8ba84a7c1a350d16e3e35b",
            measurementId: "G-6X20YG49K9"
        };

        const SCORE_WIN = 20; const SCORE_DRAW = 5; const SCORE_LOSS = -10;
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        const playersRef = collection(db, "players");
        const historyRef = collection(db, "match_history_v2");
        const systemRef = doc(db, "system", "courts_state");

        let playersList = [];
        let activeMatches = [];
        let historyList = [];
        let currentFilter = 'all';
        let myProfile = JSON.parse(localStorage.getItem('badminton_user')) || null;
        let isAdminMode = false;
        let manualSelected = []; // Stores IDs of selected players for manual match

        updateIdentityUI();

        onSnapshot(playersRef, (snapshot) => {
            playersList = [];
            snapshot.forEach(doc => playersList.push({ id: doc.id, ...doc.data() }));
            renderList();
            if(document.body.classList.contains('manual-mode-active')) renderManualList(); // Refresh manual list if open
        });

        onSnapshot(systemRef, (docSnap) => {
            if (docSnap.exists()) activeMatches = docSnap.data().matches || [];
            else activeMatches = [];
            renderCourts();
        });

        const qHistory = query(historyRef, orderBy("timestamp", "desc"), limit(2000));
        onSnapshot(qHistory, (snapshot) => {
            historyList = []; snapshot.forEach(doc => historyList.push(doc.data())); renderList();
        });

        // --- Modals ---
        window.openRankInfo = () => { document.getElementById('rankModal').classList.remove('opacity-0', 'pointer-events-none'); }
        window.closeRankModal = () => { document.getElementById('rankModal').classList.add('opacity-0', 'pointer-events-none'); }
        window.openIdentityModal = () => { document.getElementById('identityModal').classList.remove('opacity-0', 'pointer-events-none'); renderIdentityList(); }
        window.closeIdentityModal = () => { document.getElementById('identityModal').classList.add('opacity-0', 'pointer-events-none'); }
        
        // --- Manual Match Logic ---
        window.openManualModal = () => {
            manualSelected = [];
            updateManualSlots();
            renderManualList();
            document.getElementById('manualModal').classList.remove('opacity-0', 'pointer-events-none');
            document.body.classList.add('manual-mode-active');
        }
        window.closeManualModal = () => {
            document.getElementById('manualModal').classList.add('opacity-0', 'pointer-events-none');
            document.body.classList.remove('manual-mode-active');
        }

        window.toggleManualSelect = (id) => {
            const index = manualSelected.indexOf(id);
            if (index > -1) {
                // Remove
                manualSelected.splice(index, 1);
            } else {
                // Add (Max 4)
                if (manualSelected.length < 4) {
                    manualSelected.push(id);
                } else {
                    return; // Full
                }
            }
            updateManualSlots();
            renderManualList();
        }

        function updateManualSlots() {
            // Update Text in Slots
            for(let i=0; i<4; i++) {
                const el = document.getElementById(`slot-${i}`);
                if (manualSelected[i]) {
                    const p = playersList.find(x => x.id === manualSelected[i]);
                    el.innerText = p ? p.name : '...';
                    el.className = i < 2 
                        ? "bg-indigo-600 border-2 border-indigo-700 rounded p-2 text-center text-xs font-bold text-white min-h-[40px] flex items-center justify-center shadow"
                        : "bg-orange-500 border-2 border-orange-600 rounded p-2 text-center text-xs font-bold text-white min-h-[40px] flex items-center justify-center shadow";
                } else {
                    el.innerText = i < 2 ? `‡∏£‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å A${i+1}...` : `‡∏£‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å B${i-1}...`;
                    el.className = i < 2
                        ? "bg-indigo-50 border-2 border-dashed border-indigo-200 rounded p-2 text-center text-xs text-indigo-300 min-h-[40px] flex items-center justify-center"
                        : "bg-orange-50 border-2 border-dashed border-orange-200 rounded p-2 text-center text-xs text-orange-300 min-h-[40px] flex items-center justify-center";
                }
            }

            // Update Button
            const btn = document.getElementById('btnConfirmManual');
            if (manualSelected.length === 4) {
                btn.disabled = false;
                btn.innerText = "‚úÖ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏Ç‡πà‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ";
                btn.className = "w-full bg-green-500 hover:bg-green-600 text-white py-3 rounded-xl font-bold shadow-lg transition transform active:scale-95";
            } else {
                btn.disabled = true;
                btn.innerText = `‡∏Ñ‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö (${manualSelected.length}/4)`;
                btn.className = "w-full bg-slate-300 text-white py-3 rounded-xl font-bold shadow transition cursor-not-allowed";
            }
        }

        function renderManualList() {
            const list = document.getElementById('manualList');
            list.innerHTML = '';

            // Filter: Must be Present + Not playing in other matches
            const playingIds = new Set();
            activeMatches.forEach(m => { m.teamA.forEach(p => playingIds.add(p.id)); m.teamB.forEach(p => playingIds.add(p.id)); });

            let eligible = playersList.filter(p => p.isPresent).sort((a,b) => b.score - a.score);

            eligible.forEach(p => {
                const isSelected = manualSelected.includes(p.id);
                const isPlaying = playingIds.has(p.id);
                const rankInfo = getRankInfo(p.score);

                // Disable logic
                let cardClass = `flex justify-between items-center p-3 rounded-lg border-2 mb-2 relative transition cursor-pointer select-none `;
                
                if (isSelected) {
                    cardClass += "selected-player border-indigo-500 shadow-md";
                } else if (isPlaying) {
                    cardClass += "bg-slate-100 border-slate-100 opacity-40 cursor-not-allowed grayscale";
                } else {
                    cardClass += `bg-white ${rankInfo.frame} hover:bg-slate-50`;
                }

                const onclick = isPlaying ? '' : `onclick="toggleManualSelect('${p.id}')"`;

                list.innerHTML += `
                    <div ${onclick} class="${cardClass}">
                        <div class="flex items-center gap-3">
                            <div class="font-bold text-lg">${rankInfo.icon}</div>
                            <div>
                                <div class="font-bold text-sm ${isSelected ? 'text-white' : 'text-slate-700'}">
                                    ${p.name}
                                    ${isPlaying ? '<span class="text-[10px] text-red-500">(‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏¢‡∏π‡πà)</span>' : ''}
                                </div>
                                <div class="text-[10px] ${isSelected ? 'sub-text' : 'text-slate-400'} font-bold">
                                    ${rankInfo.name} | MMR ${p.score}
                                </div>
                            </div>
                        </div>
                        ${isSelected ? '<div class="text-white text-xl">‚úì</div>' : ''}
                    </div>
                `;
            });
        }

        window.confirmManualMatch = async () => {
            if (manualSelected.length !== 4) return;
            
            // Construct Match Object
            // Slot 0,1 = Team A | Slot 2,3 = Team B
            const pA1 = playersList.find(x => x.id === manualSelected[0]);
            const pA2 = playersList.find(x => x.id === manualSelected[1]);
            const pB1 = playersList.find(x => x.id === manualSelected[2]);
            const pB2 = playersList.find(x => x.id === manualSelected[3]);

            const newMatches = [...activeMatches];
            newMatches.push({
                id: Date.now(),
                courtNo: findNextCourtNo(newMatches),
                teamA: [pA1, pA2],
                teamB: [pB1, pB2],
                startTime: Date.now()
            });

            await setDoc(systemRef, { matches: newMatches });
            closeManualModal();
        }


        // --- Render Lists ---
        window.renderIdentityList = () => {
            const list = document.getElementById('identityList');
            const search = document.getElementById('searchIdentity').value.toLowerCase();
            list.innerHTML = '';
            const filtered = playersList.filter(p => p.name.toLowerCase().includes(search));
            if(myProfile) list.innerHTML += `<button onclick="logoutIdentity()" class="w-full text-left px-4 py-2 text-red-500 font-bold border border-red-200 rounded hover:bg-red-50 mb-2">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö (${myProfile.name})</button>`;
            filtered.sort((a,b) => a.name.localeCompare(b.name)).forEach(p => {
                const isActive = myProfile && myProfile.id === p.id;
                list.innerHTML += `<button onclick="selectIdentity('${p.id}', '${p.name}')" class="w-full text-left px-4 py-3 rounded border ${isActive ? 'bg-indigo-50 border-indigo-500 text-indigo-700' : 'bg-white border-slate-100 hover:bg-slate-50'}">${p.name} ${isActive ? '‚úÖ' : ''}</button>`;
            });
        }
        window.filterIdentityList = renderIdentityList;
        window.selectIdentity = (id, name) => { myProfile = { id, name }; localStorage.setItem('badminton_user', JSON.stringify(myProfile)); updateIdentityUI(); closeIdentityModal(); renderCourts(); }
        window.logoutIdentity = () => { myProfile = null; localStorage.removeItem('badminton_user'); updateIdentityUI(); closeIdentityModal(); renderCourts(); }
        function updateIdentityUI() {
            const nameEl = document.getElementById('myName'); const statusEl = document.getElementById('idStatus');
            if (myProfile) { nameEl.innerText = myProfile.name; nameEl.className = "font-bold text-indigo-700"; statusEl.className = "w-2 h-2 rounded-full bg-green-500"; }
            else { nameEl.innerText = "‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏±‡∏ß‡∏ï‡∏ô"; nameEl.className = "text-slate-500"; statusEl.className = "w-2 h-2 rounded-full bg-slate-300"; }
        }

        function renderCourts() {
            const container = document.getElementById('courtsContainer');
            container.innerHTML = '';
            activeMatches.sort((a, b) => a.courtNo - b.courtNo);
            if (activeMatches.length === 0) { container.innerHTML = `<div class="text-center text-slate-400 py-6 col-span-full border-2 border-dashed border-slate-200 rounded-xl">‡∏™‡∏ô‡∏≤‡∏°‡∏ß‡πà‡∏≤‡∏á...</div>`; return; }

            activeMatches.forEach(m => {
                let amIPlaying = false;
                if (myProfile) { const allPlayers = [...m.teamA, ...m.teamB]; amIPlaying = allPlayers.some(p => p.id === myProfile.id); }
                const showControls = isAdminMode || amIPlaying;
                const controlClass = showControls ? '' : 'hidden';
                const borderClass = amIPlaying ? 'ring-4 ring-yellow-400' : '';

                container.innerHTML += `
                    <div class="rounded-xl p-1 shadow-lg text-white bg-gradient-to-br from-slate-700 to-slate-800 court-card relative ${borderClass}">
                        <div class="absolute top-2 left-2 bg-white/20 px-2 rounded text-xs font-bold">Court ${m.courtNo}</div>
                        ${amIPlaying ? '<div class="absolute top-2 right-12 bg-yellow-400 text-black px-2 rounded text-[10px] font-bold animate-pulse">‡∏Ñ‡∏¥‡∏ß‡∏Ñ‡∏∏‡∏ì!</div>' : ''}
                        <button onclick="cancelMatch(${m.id})" class="absolute top-2 right-2 text-white/50 hover:text-white text-xs admin-only">‚úñ</button>
                        <div class="bg-white rounded-lg p-3 text-slate-800 mt-8">
                            <div class="flex justify-between items-center mb-1 p-1 rounded hover:bg-indigo-50 border-l-4 border-indigo-500">
                                <div class="text-sm font-bold leading-tight pl-2">${m.teamA[0].name}<br>${m.teamA[1].name}</div>
                                <button onclick="finishMatch(${m.id}, 'A_WIN')" class="${controlClass} bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full text-xs font-bold hover:bg-indigo-200 shadow-sm border border-indigo-200">A ‡∏ä‡∏ô‡∏∞</button>
                            </div>
                            <div class="flex justify-center my-1"><button onclick="finishMatch(${m.id}, 'DRAW')" class="${controlClass} bg-slate-100 text-slate-500 px-4 py-0.5 rounded-full text-[10px] font-bold hover:bg-slate-200 border border-slate-300">‡πÄ‡∏™‡∏°‡∏≠</button></div>
                            <div class="flex justify-between items-center mt-1 p-1 rounded hover:bg-orange-50 border-l-4 border-orange-500">
                                <div class="text-sm font-bold leading-tight pl-2">${m.teamB[0].name}<br>${m.teamB[1].name}</div>
                                <button onclick="finishMatch(${m.id}, 'B_WIN')" class="${controlClass} bg-orange-100 text-orange-700 px-3 py-1 rounded-full text-xs font-bold hover:bg-orange-200 shadow-sm border border-orange-200">B ‡∏ä‡∏ô‡∏∞</button>
                            </div>
                            ${!showControls ? '<div class="text-center text-[10px] text-slate-300 mt-2">‡∏£‡∏≠‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô...</div>' : ''}
                        </div>
                    </div>
                `;
            });
        }

        // --- Core ---
        function calculateStats(player, filter) {
            if (filter === 'all') return { value: player.score, label: 'MMR', displayClass: 'text-slate-800' };
            const now = new Date(); let cutoff = new Date();
            if (filter === 'day') cutoff.setHours(0,0,0,0);
            if (filter === 'month') { cutoff.setDate(1); cutoff.setHours(0,0,0,0); }
            const timestampCutoff = cutoff.getTime();
            const relevantMatches = historyList.filter(m => m.timestamp >= timestampCutoff);
            let netChange = 0; let wins = 0, draws = 0, losses = 0;
            relevantMatches.forEach(m => {
                let change = 0;
                if (m.teamA_ids.includes(player.id)) change = m.change_A;
                else if (m.teamB_ids.includes(player.id)) change = m.change_B;
                if (change !== 0) { netChange += change; if (change > 0 && change >= SCORE_WIN) wins++; else if (change < 0) losses++; else draws++; }
            });
            let label = netChange > 0 ? `+${netChange}` : `${netChange}`;
            let displayClass = netChange > 0 ? 'text-green-600' : (netChange < 0 ? 'text-red-500' : 'text-slate-400');
            return { value: netChange, label, displayClass, wins, draws, losses };
        }
        function getRankInfo(score) {
            if (score >= 2000) return { frame: 'frame-master', icon: 'üî•', name: 'Grand Master' };
            if (score >= 1800) return { frame: 'frame-diamond', icon: 'üíé', name: 'Diamond' };
            if (score >= 1500) return { frame: 'frame-gold', icon: 'ü•á', name: 'Gold' };
            if (score >= 1300) return { frame: 'frame-silver', icon: 'ü•à', name: 'Silver' };
            if (score >= 1100) return { frame: 'frame-bronze', icon: 'ü•â', name: 'Bronze' };
            return { frame: 'frame-rookie', icon: 'üê£', name: 'Rookie' };
        }

        document.getElementById('btnAdd').onclick = async () => {
            const name = document.getElementById('inputName').value.trim();
            if (!name) return;
            if(playersList.some(p => p.name == name)) { alert('‡∏ä‡∏∑‡πà‡∏≠‡∏ã‡πâ‡∏≥!'); return; }
            await addDoc(playersRef, { name: name, score: 1000, matches: 0, wins: 0, draws: 0, losses: 0, isPresent: true, createdAt: Date.now() });
            document.getElementById('inputName').value = '';
        };
        window.togglePresence = async (id, currentStatus) => { await updateDoc(doc(db, "players", id), { isPresent: !currentStatus }); }
        window.resetDay = async () => { if(!confirm("‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠?")) return; const batch = writeBatch(db); playersList.forEach(p => batch.update(doc(db, "players", p.id), { isPresent: false })); await batch.commit(); }
        window.deletePlayer = async (id) => { if(confirm("‡∏•‡∏ö‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡∏ñ‡∏≤‡∏ß‡∏£?")) await deleteDoc(doc(db, "players", id)); }

        document.getElementById('btnGenerate').onclick = async () => {
            const maxCourts = parseInt(document.getElementById('courtCount').value);
            const slots = maxCourts - activeMatches.length;
            if (slots <= 0) return alert("‡∏Ñ‡∏≠‡∏£‡πå‡∏ó‡πÄ‡∏ï‡πá‡∏°!");
            const playingIds = new Set();
            activeMatches.forEach(m => { m.teamA.forEach(p => playingIds.add(p.id)); m.teamB.forEach(p => playingIds.add(p.id)); });
            let pool = playersList.filter(p => p.isPresent && !playingIds.has(p.id));
            if (pool.length < 4) return alert("‡∏Ñ‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠!");
            pool.sort((a, b) => a.matches - b.matches || 0.5 - Math.random());
            const newMatches = [...activeMatches];
            for (let i = 0; i < slots; i++) {
                if (pool.length < 4) break;
                let sel = pool.slice(0, 4); pool = pool.slice(4);
                sel.sort((a, b) => b.score - a.score);
                newMatches.push({ id: Date.now() + i, courtNo: findNextCourtNo(newMatches), teamA: [sel[0], sel[3]], teamB: [sel[1], sel[2]], startTime: Date.now() });
            }
            await setDoc(systemRef, { matches: newMatches });
        };
        function findNextCourtNo(list) { const used = new Set(list.map(m => m.courtNo)); let i = 1; while(used.has(i)) i++; return i; }

        window.finishMatch = async (matchId, result) => {
            const msg = result === 'DRAW' ? '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ú‡∏• ‡πÄ‡∏™‡∏°‡∏≠?' : `‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ó‡∏µ‡∏° ${result === 'A_WIN' ? 'A' : 'B'} ‡∏ä‡∏ô‡∏∞?`;
            if (!confirm(msg)) return;
            const match = activeMatches.find(m => m.id === matchId);
            if (!match) return;
            const batch = writeBatch(db);
            let changeA = 0, changeB = 0;
            if (result === 'A_WIN') { changeA = SCORE_WIN; changeB = SCORE_LOSS; } else if (result === 'B_WIN') { changeA = SCORE_LOSS; changeB = SCORE_WIN; } else { changeA = SCORE_DRAW; changeB = SCORE_DRAW; }
            [...match.teamA, ...match.teamB].forEach(p => {
                const isA = match.teamA.some(x => x.id === p.id);
                const change = isA ? changeA : changeB;
                const ref = doc(db, "players", p.id);
                const curr = playersList.find(x => x.id === p.id);
                if(curr) {
                    const newScore = Math.max(0, curr.score + change);
                    const wins = curr.wins + ((isA && result==='A_WIN') || (!isA && result==='B_WIN') ? 1 : 0);
                    const draws = (curr.draws || 0) + (result === 'DRAW' ? 1 : 0);
                    const losses = (curr.losses || 0) + (change < 0 ? 1 : 0);
                    batch.update(ref, { score: newScore, matches: curr.matches + 1, wins, draws, losses });
                }
            });
            const historyDoc = doc(historyRef);
            batch.set(historyDoc, { timestamp: Date.now(), result_type: result, teamA_ids: match.teamA.map(p => p.id), teamB_ids: match.teamB.map(p => p.id), change_A: changeA, change_B: changeB });
            const remaining = activeMatches.filter(m => m.id !== matchId);
            batch.set(systemRef, { matches: remaining });
            await batch.commit();
        };
        window.cancelMatch = async (matchId) => { if(!confirm("‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å?")) return; const remaining = activeMatches.filter(m => m.id !== matchId); await setDoc(systemRef, { matches: remaining }); }
        window.setFilter = (filter) => {
            currentFilter = filter;
            ['all','month','day'].forEach(f => {
                const btn = document.getElementById(`tab-${f}`);
                if(f === filter) btn.className = "flex-1 py-1.5 text-xs font-bold rounded-md bg-white shadow text-indigo-600 transition";
                else btn.className = "flex-1 py-1.5 text-xs font-bold rounded-md text-slate-500 hover:bg-white/50 transition";
            });
            const titles = { all: "‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (MMR)", month: "‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ (‡πÅ‡∏ï‡πâ‡∏°)", day: "‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (‡πÅ‡∏ï‡πâ‡∏°)" };
            document.getElementById('rankTitle').innerText = titles[filter];
            renderList();
        }

        function renderList() {
            const list = document.getElementById('listContainer');
            list.innerHTML = '';
            let displayList = playersList.map(p => { const stats = calculateStats(p, currentFilter); return { ...p, ...stats }; });
            displayList.sort((a, b) => b.value - a.value);
            const playingIds = new Set();
            activeMatches.forEach(m => { m.teamA.forEach(p => playingIds.add(p.id)); m.teamB.forEach(p => playingIds.add(p.id)); });

            displayList.forEach((p, idx) => {
                if (currentFilter !== 'all' && p.value === 0) return;
                const rankInfo = getRankInfo(p.score);
                const isPlaying = playingIds.has(p.id);
                list.innerHTML += `
                    <div class="flex justify-between items-center p-3 rounded-lg mb-2 card-base ${rankInfo.frame} ${!p.isPresent ? 'opacity-50 grayscale border-slate-200 bg-white' : ''} relative">
                        <div class="flex items-center gap-3">
                            <div class="admin-only"><input type="checkbox" ${p.isPresent ? 'checked' : ''} onchange="togglePresence('${p.id}', ${p.isPresent})" class="w-4 h-4 rounded text-indigo-600 cursor-pointer"></div>
                            <div class="font-bold text-slate-400 w-5 text-center text-sm">${idx+1}</div>
                            <div>
                                <div class="font-bold text-slate-700 flex items-center gap-2 text-base">
                                    ${rankInfo.icon} ${p.name}
                                    ${isPlaying ? '<span class="text-[8px] bg-indigo-500 text-white px-1.5 rounded animate-pulse">PLAYING</span>' : ''}
                                </div>
                                <div class="text-[10px] text-slate-400 font-bold tracking-wide flex gap-2">
                                    W:${p.wins || 0} D:${p.draws || 0} L:${p.losses || 0}
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="text-right">
                                <div class="font-bold text-lg ${p.displayClass}">${p.label}</div>
                                <div class="text-[10px] text-slate-400">‡πÅ‡∏Ç‡πà‡∏á ${p.matches}</div>
                            </div>
                            <button onclick="deletePlayer('${p.id}')" class="admin-only text-slate-300 hover:text-red-500 text-xl px-1">√ó</button>
                        </div>
                    </div>
                `;
            });
            if(list.innerHTML === '') list.innerHTML = `<div class="text-center text-sm text-slate-400 py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>`;
        }

        window.toggleAdmin = function() {
            if(isAdminMode) { isAdminMode = false; document.body.classList.remove('show-admin'); document.getElementById('adminPanel').classList.add('hidden'); document.getElementById('addPlayerBox').classList.add('hidden'); renderCourts(); }
            else { const pass = prompt("Admin Password:"); if (pass === "1234") { isAdminMode = true; document.body.classList.add('show-admin'); document.getElementById('adminPanel').classList.remove('hidden'); document.getElementById('addPlayerBox').classList.remove('hidden'); renderCourts(); } }
        }
    </script>
</body>
</html>
