<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Badminton Pro League üèÜ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Kanit', sans-serif; background-color: #f8fafc; }
        
        /* Rank Colors */
        .rank-rookie { border-left: 4px solid #94a3b8; }
        .rank-bronze { border-left: 4px solid #d97706; background: linear-gradient(90deg, #fffbeb 0%, #fff 100%); }
        .rank-silver { border-left: 4px solid #64748b; background: linear-gradient(90deg, #f8fafc 0%, #fff 100%); }
        .rank-gold   { border-left: 4px solid #eab308; background: linear-gradient(90deg, #fefce8 0%, #fff 100%); }
        .rank-diamond{ border-left: 4px solid #0ea5e9; background: linear-gradient(90deg, #f0f9ff 0%, #fff 100%); }
        .rank-master { border-left: 4px solid #a855f7; background: linear-gradient(90deg, #faf5ff 0%, #fff 100%); }

        .admin-only { display: none !important; } 
        .show-admin .admin-only { display: block !important; }
        .show-admin .admin-flex { display: flex !important; }
    </style>
</head>
<body class="p-4 max-w-2xl mx-auto pb-40">

    <div class="flex justify-between items-center mb-4 sticky top-0 bg-[#f8fafc] z-20 py-2">
        <div>
            <h1 class="text-2xl font-bold text-slate-800">üè∏ Badminton <span class="text-indigo-600">Pro</span></h1>
            <div id="statusIndicator" class="text-[10px] inline-block px-2 py-0.5 rounded bg-gray-200 text-gray-500">Connecting...</div>
        </div>
        <button onclick="toggleAdmin()" class="text-xl p-2 bg-white shadow rounded-full hover:scale-110 transition">üîí</button>
    </div>

    <div class="bg-slate-800 text-white p-4 rounded-xl shadow-lg mb-6 admin-only hidden" id="adminPanel">
        <h3 class="font-bold text-sm mb-3 text-slate-300 flex justify-between">
            ‚öôÔ∏è ‡πÅ‡∏ú‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°
            <button onclick="resetDay()" class="text-[10px] text-red-300 border border-red-300 px-2 rounded hover:bg-red-500 hover:text-white">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ß‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà</button>
        </h3>
        <div class="flex gap-3 mb-4">
            <select id="courtCount" class="bg-slate-700 rounded px-2 py-1 text-sm flex-1">
                <option value="1">1 ‡∏Ñ‡∏≠‡∏£‡πå‡∏ó</option>
                <option value="2" selected>2 ‡∏Ñ‡∏≠‡∏£‡πå‡∏ó</option>
                <option value="3">3 ‡∏Ñ‡∏≠‡∏£‡πå‡∏ó</option>
            </select>
        </div>
        <button id="btnGenerate" class="w-full bg-indigo-500 hover:bg-indigo-600 py-3 rounded-lg font-bold shadow-lg active:scale-95 transition">
            üöÄ ‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ ‚úÖ)
        </button>
    </div>

    <div id="courtsContainer" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6"></div>

    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4">
        
        <div class="flex gap-2 mb-4 admin-only hidden" id="addPlayerBox">
            <input type="text" id="inputName" placeholder="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å..." class="flex-1 bg-slate-50 border rounded px-3 py-2 text-sm">
            <button id="btnAdd" class="bg-indigo-600 text-white px-4 rounded font-bold hover:bg-indigo-700">+</button>
        </div>

        <div class="flex p-1 bg-slate-100 rounded-lg mb-4">
            <button onclick="setFilter('all')" id="tab-all" class="flex-1 py-1.5 text-xs font-bold rounded-md bg-white shadow text-indigo-600 transition">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
            <button onclick="setFilter('month')" id="tab-month" class="flex-1 py-1.5 text-xs font-bold rounded-md text-slate-500 hover:bg-white/50 transition">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</button>
            <button onclick="setFilter('day')" id="tab-day" class="flex-1 py-1.5 text-xs font-bold rounded-md text-slate-500 hover:bg-white/50 transition">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
        </div>

        <div class="flex justify-between items-end mb-2 px-2">
            <span class="text-sm font-bold text-slate-700" id="rankTitle">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (MMR)</span>
            <span class="text-[10px] text-slate-400">‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ ‚úÖ</span>
        </div>

        <div id="listContainer" class="space-y-2 pb-10"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, setDoc, writeBatch, query, where, orderBy, limit } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        // üî¥üî¥ Config ‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì üî¥üî¥
        const firebaseConfig = {
            apiKey: "AIzaSyC6VSnH2H5zyFPbya0axgP38WiGczYU-oU",
            authDomain: "badminton-smasher-ai.firebaseapp.com",
            projectId: "badminton-smasher-ai",
            storageBucket: "badminton-smasher-ai.firebasestorage.app",
            messagingSenderId: "518167738562",
            appId: "1:518167738562:web:8ba84a7c1a350d16e3e35b",
            measurementId: "G-6X20YG49K9"
        };

        // ‚öôÔ∏è Game Rules
        const SCORE_WIN = 20;
        const SCORE_DRAW = 5;
        const SCORE_LOSS = -10;

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        const playersRef = collection(db, "players");
        const historyRef = collection(db, "match_history_v2");
        const systemRef = doc(db, "system", "courts_state");

        let playersList = [];
        let activeMatches = [];
        let historyList = [];
        let currentFilter = 'all';

        // --- Listeners ---
        onSnapshot(playersRef, (snapshot) => {
            document.getElementById('statusIndicator').innerText = "Online üü¢";
            document.getElementById('statusIndicator').className = "text-[10px] inline-block px-2 py-0.5 rounded bg-green-100 text-green-700";
            playersList = [];
            snapshot.forEach(doc => playersList.push({ id: doc.id, ...doc.data() }));
            renderList();
        });

        onSnapshot(systemRef, (docSnap) => {
            if (docSnap.exists()) activeMatches = docSnap.data().matches || [];
            else activeMatches = [];
            renderCourts();
        });

        const qHistory = query(historyRef, orderBy("timestamp", "desc"), limit(2000));
        onSnapshot(qHistory, (snapshot) => {
            historyList = [];
            snapshot.forEach(doc => historyList.push(doc.data()));
            renderList();
        });

        // --- Helpers ---
        function calculateStats(player, filter) {
            if (filter === 'all') return { value: player.score, label: 'MMR', displayClass: 'text-slate-800' };
            const now = new Date();
            let cutoff = new Date();
            if (filter === 'day') cutoff.setHours(0,0,0,0);
            if (filter === 'month') { cutoff.setDate(1); cutoff.setHours(0,0,0,0); }

            const timestampCutoff = cutoff.getTime();
            const relevantMatches = historyList.filter(m => m.timestamp >= timestampCutoff);
            
            let netChange = 0;
            let wins = 0, draws = 0, losses = 0;

            relevantMatches.forEach(m => {
                let change = 0;
                if (m.teamA_ids.includes(player.id)) change = m.change_A;
                else if (m.teamB_ids.includes(player.id)) change = m.change_B;
                
                if (change !== 0) {
                    netChange += change;
                    if (change > 0 && change >= SCORE_WIN) wins++;
                    else if (change < 0) losses++;
                    else draws++;
                }
            });

            let label = netChange > 0 ? `+${netChange}` : `${netChange}`;
            let displayClass = netChange > 0 ? 'text-green-600' : (netChange < 0 ? 'text-red-500' : 'text-slate-400');
            return { value: netChange, label, displayClass, wins, draws, losses };
        }

        function getRankTier(score) {
            if (score >= 2000) return { name: 'GRAND MASTER üî•', color: 'rank-master', text: 'text-purple-600' };
            if (score >= 1800) return { name: 'DIAMOND üíé', color: 'rank-diamond', text: 'text-sky-500' };
            if (score >= 1500) return { name: 'GOLD ü•á', color: 'rank-gold', text: 'text-yellow-500' };
            if (score >= 1300) return { name: 'SILVER ü•à', color: 'rank-silver', text: 'text-slate-500' };
            if (score >= 1100) return { name: 'BRONZE ü•â', color: 'rank-bronze', text: 'text-orange-500' };
            return { name: 'ROOKIE üê£', color: 'rank-rookie', text: 'text-slate-400' };
        }

        // --- Actions ---
        document.getElementById('btnAdd').onclick = async () => {
            const name = document.getElementById('inputName').value.trim();
            if (!name) return;
            if(playersList.some(p => p.name == name)) { alert('‡∏ä‡∏∑‡πà‡∏≠‡∏ã‡πâ‡∏≥!'); return; }
            await addDoc(playersRef, { name: name, score: 1000, matches: 0, wins: 0, draws: 0, losses: 0, isPresent: true, createdAt: Date.now() });
            document.getElementById('inputName').value = '';
        };

        window.togglePresence = async (id, currentStatus) => {
            await updateDoc(doc(db, "players", id), { isPresent: !currentStatus });
        }

        window.resetDay = async () => {
            if(!confirm("‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠?")) return;
            const batch = writeBatch(db);
            playersList.forEach(p => batch.update(doc(db, "players", p.id), { isPresent: false }));
            await batch.commit();
        }
        
        // ‚úÖ ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
        window.deletePlayer = async (id) => {
             if(confirm("‡∏•‡∏ö‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡∏ñ‡∏≤‡∏ß‡∏£?")) await deleteDoc(doc(db, "players", id));
        }

        document.getElementById('btnGenerate').onclick = async () => {
            const maxCourts = parseInt(document.getElementById('courtCount').value);
            const slots = maxCourts - activeMatches.length;
            if (slots <= 0) return alert("‡∏Ñ‡∏≠‡∏£‡πå‡∏ó‡πÄ‡∏ï‡πá‡∏°!");

            const playingIds = new Set();
            activeMatches.forEach(m => {
                m.teamA.forEach(p => playingIds.add(p.id));
                m.teamB.forEach(p => playingIds.add(p.id));
            });

            let pool = playersList.filter(p => p.isPresent && !playingIds.has(p.id));
            if (pool.length < 4) return alert("‡∏Ñ‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠!");
            
            pool.sort((a, b) => a.matches - b.matches || 0.5 - Math.random());

            const newMatches = [...activeMatches];
            for (let i = 0; i < slots; i++) {
                if (pool.length < 4) break;
                let sel = pool.slice(0, 4);
                pool = pool.slice(4);
                sel.sort((a, b) => b.score - a.score);
                newMatches.push({
                    id: Date.now() + i,
                    courtNo: findNextCourtNo(newMatches),
                    teamA: [sel[0], sel[3]],
                    teamB: [sel[1], sel[2]],
                    startTime: Date.now()
                });
            }
            await setDoc(systemRef, { matches: newMatches });
        };

        function findNextCourtNo(list) {
            const used = new Set(list.map(m => m.courtNo));
            let i = 1; while(used.has(i)) i++; return i;
        }

        window.finishMatch = async (matchId, result) => {
            const msg = result === 'DRAW' ? '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ú‡∏• ‡πÄ‡∏™‡∏°‡∏≠?' : `‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ó‡∏µ‡∏° ${result === 'A_WIN' ? 'A' : 'B'} ‡∏ä‡∏ô‡∏∞?`;
            if (!confirm(msg)) return;

            const match = activeMatches.find(m => m.id === matchId);
            if (!match) return;

            const batch = writeBatch(db);
            let changeA = 0, changeB = 0;

            if (result === 'A_WIN') { changeA = SCORE_WIN; changeB = SCORE_LOSS; }
            else if (result === 'B_WIN') { changeA = SCORE_LOSS; changeB = SCORE_WIN; }
            else { changeA = SCORE_DRAW; changeB = SCORE_DRAW; }

            [...match.teamA, ...match.teamB].forEach(p => {
                const isA = match.teamA.some(x => x.id === p.id);
                const change = isA ? changeA : changeB;
                const ref = doc(db, "players", p.id);
                const curr = playersList.find(x => x.id === p.id);
                if(curr) {
                    const newScore = Math.max(0, curr.score + change);
                    const wins = curr.wins + ((isA && result==='A_WIN') || (!isA && result==='B_WIN') ? 1 : 0);
                    const draws = (curr.draws || 0) + (result === 'DRAW' ? 1 : 0);
                    const losses = (curr.losses || 0) + (change < 0 ? 1 : 0);
                    batch.update(ref, { score: newScore, matches: curr.matches + 1, wins, draws, losses });
                }
            });

            const historyDoc = doc(historyRef);
            batch.set(historyDoc, {
                timestamp: Date.now(),
                result_type: result,
                teamA_ids: match.teamA.map(p => p.id),
                teamB_ids: match.teamB.map(p => p.id),
                change_A: changeA,
                change_B: changeB
            });

            const remaining = activeMatches.filter(m => m.id !== matchId);
            batch.set(systemRef, { matches: remaining });
            await batch.commit();
        };

        window.cancelMatch = async (matchId) => {
            if(!confirm("‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å?")) return;
            const remaining = activeMatches.filter(m => m.id !== matchId);
            await setDoc(systemRef, { matches: remaining });
        }

        window.setFilter = (filter) => {
            currentFilter = filter;
            ['all','month','day'].forEach(f => {
                const btn = document.getElementById(`tab-${f}`);
                if(f === filter) btn.className = "flex-1 py-1.5 text-xs font-bold rounded-md bg-white shadow text-indigo-600 transition";
                else btn.className = "flex-1 py-1.5 text-xs font-bold rounded-md text-slate-500 hover:bg-white/50 transition";
            });
            const titles = { all: "‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (MMR)", month: "‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ (‡πÅ‡∏ï‡πâ‡∏°)", day: "‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (‡πÅ‡∏ï‡πâ‡∏°)" };
            document.getElementById('rankTitle').innerText = titles[filter];
            renderList();
        }

        function renderCourts() {
            const container = document.getElementById('courtsContainer');
            container.innerHTML = '';
            activeMatches.sort((a, b) => a.courtNo - b.courtNo);

            if (activeMatches.length === 0) {
                container.innerHTML = `<div class="text-center text-slate-400 py-6 col-span-full border-2 border-dashed border-slate-200 rounded-xl">‡∏™‡∏ô‡∏≤‡∏°‡∏ß‡πà‡∏≤‡∏á...
